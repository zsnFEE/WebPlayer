<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ MP4Boxç›´æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            margin: 0;
        }
        .status { 
            padding: 8px; 
            margin: 5px 0; 
            border-radius: 4px; 
            border-left: 4px solid;
        }
        .success { background: #1a3a1a; border-color: #4CAF50; }
        .error { background: #3a1a1a; border-color: #f44336; }
        .warning { background: #3a3a1a; border-color: #ff9800; }
        .info { background: #1a1a3a; border-color: #2196F3; }
        .log { 
            background: #111; 
            padding: 15px; 
            border-radius: 5px; 
            max-height: 400px; 
            overflow-y: auto; 
            white-space: pre-wrap;
            font-size: 12px;
            border: 1px solid #333;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #1976D2; }
        button:disabled { background: #666; cursor: not-allowed; }
        input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border: 1px solid #666;
            color: white;
            border-radius: 4px;
        }
        .test-section {
            background: #222;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .step {
            margin: 8px 0;
            padding: 8px;
            border-left: 3px solid #666;
            background: #333;
        }
        .step.active { border-color: #2196F3; background: #1a2a3a; }
        .step.success { border-color: #4CAF50; background: #1a3a1a; }
        .step.error { border-color: #f44336; background: #3a1a1a; }
    </style>
</head>
<body>
    <h1>ğŸ”§ MP4Boxæ ¸å¿ƒåŠŸèƒ½æµ‹è¯•</h1>
    <p>ä¸“é—¨æµ‹è¯•MP4Boxåº“æœ¬èº«æ˜¯å¦èƒ½æ­£å¸¸è§£æMP4æ–‡ä»¶</p>

    <!-- MP4Boxåº“çŠ¶æ€ -->
    <div class="test-section">
        <h3>ğŸ“¦ MP4Boxåº“çŠ¶æ€</h3>
        <div id="mp4box-status"></div>
        <button onclick="checkMP4BoxVersion()">æ£€æŸ¥MP4Boxç‰ˆæœ¬</button>
    </div>

    <!-- åŸºç¡€åŠŸèƒ½æµ‹è¯• -->
    <div class="test-section">
        <h3>ğŸ§ª åŸºç¡€åŠŸèƒ½æµ‹è¯•</h3>
        <div id="basic-tests"></div>
        <button onclick="runBasicTests()">è¿è¡ŒåŸºç¡€æµ‹è¯•</button>
    </div>

    <!-- æ–‡ä»¶è§£ææµ‹è¯• -->
    <div class="test-section">
        <h3>ğŸ“ æ–‡ä»¶è§£ææµ‹è¯•</h3>
        <input type="file" id="testFile" accept="video/*">
        <button onclick="testFileDirectly()" id="testBtn" disabled>ç›´æ¥æµ‹è¯•MP4Boxè§£æ</button>
        
        <div id="parse-steps">
            <div class="step" id="step-load">1. æ–‡ä»¶åŠ è½½</div>
            <div class="step" id="step-create">2. MP4Boxå®ä¾‹åˆ›å»º</div>
            <div class="step" id="step-callbacks">3. å›è°ƒå‡½æ•°è®¾ç½®</div>
            <div class="step" id="step-append">4. æ•°æ®æ·»åŠ </div>
            <div class="step" id="step-start">5. è§£æå¯åŠ¨</div>
            <div class="step" id="step-result">6. è§£æç»“æœ</div>
        </div>
    </div>

    <!-- è¯¦ç»†æ—¥å¿— -->
    <div class="test-section">
        <h3>ğŸ“‹ è¯¦ç»†æµ‹è¯•æ—¥å¿—</h3>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="log" class="log"></div>
    </div>

    <!-- åŠ è½½MP4Box -->
    <script src="https://unpkg.com/mp4box@0.5.2/dist/mp4box.all.min.js"></script>
    
    <script>
        let mp4boxFile = null;
        let testFileData = null;

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#2196F3',
                success: '#4CAF50', 
                error: '#f44336',
                warning: '#ff9800'
            };
            
            logEl.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateStep(stepId, status) {
            const step = document.getElementById(stepId);
            step.className = `step ${status}`;
        }

        function addStatus(containerId, message, type) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
        }

        // æ£€æŸ¥MP4Boxç‰ˆæœ¬å’ŒçŠ¶æ€
        function checkMP4BoxVersion() {
            log('æ£€æŸ¥MP4BoxçŠ¶æ€...', 'info');
            
            if (typeof MP4Box === 'undefined') {
                log('âŒ MP4Boxåº“æœªåŠ è½½', 'error');
                addStatus('mp4box-status', 'âŒ MP4Boxåº“æœªåŠ è½½', 'error');
                return;
            }

            try {
                log('âœ… MP4Boxåº“å·²åŠ è½½', 'success');
                addStatus('mp4box-status', 'âœ… MP4Boxåº“å·²åŠ è½½', 'success');
                
                // æ£€æŸ¥MP4Boxçš„æ–¹æ³•
                const methods = ['createFile', 'Log', 'TRAK_TYPE_VIDEO', 'TRAK_TYPE_AUDIO'];
                methods.forEach(method => {
                    if (MP4Box[method] !== undefined) {
                        log(`âœ… MP4Box.${method} å¯ç”¨`, 'success');
                        addStatus('mp4box-status', `âœ… ${method} å¯ç”¨`, 'success');
                    } else {
                        log(`âŒ MP4Box.${method} ä¸å¯ç”¨`, 'error');
                        addStatus('mp4box-status', `âŒ ${method} ä¸å¯ç”¨`, 'error');
                    }
                });

                // å°è¯•åˆ›å»ºæ–‡ä»¶å®ä¾‹
                const testFile = MP4Box.createFile();
                if (testFile) {
                    log('âœ… MP4Box.createFile() æˆåŠŸ', 'success');
                    addStatus('mp4box-status', 'âœ… createFile() æµ‹è¯•æˆåŠŸ', 'success');
                } else {
                    log('âŒ MP4Box.createFile() å¤±è´¥', 'error');
                    addStatus('mp4box-status', 'âŒ createFile() æµ‹è¯•å¤±è´¥', 'error');
                }

            } catch (error) {
                log(`âŒ MP4Boxæ£€æŸ¥å‡ºé”™: ${error.message}`, 'error');
                addStatus('mp4box-status', `âŒ æ£€æŸ¥å‡ºé”™: ${error.message}`, 'error');
            }
        }

        // è¿è¡ŒåŸºç¡€æµ‹è¯•
        function runBasicTests() {
            log('å¼€å§‹åŸºç¡€åŠŸèƒ½æµ‹è¯•...', 'info');
            
            const tests = [
                {
                    name: 'åˆ›å»ºMP4Boxå®ä¾‹',
                    test: () => {
                        const file = MP4Box.createFile();
                        return !!file;
                    }
                },
                {
                    name: 'è®¾ç½®onReadyå›è°ƒ',
                    test: () => {
                        const file = MP4Box.createFile();
                        file.onReady = () => {};
                        return typeof file.onReady === 'function';
                    }
                },
                {
                    name: 'è®¾ç½®onErrorå›è°ƒ',
                    test: () => {
                        const file = MP4Box.createFile();
                        file.onError = () => {};
                        return typeof file.onError === 'function';
                    }
                },
                {
                    name: 'æ£€æŸ¥appendBufferæ–¹æ³•',
                    test: () => {
                        const file = MP4Box.createFile();
                        return typeof file.appendBuffer === 'function';
                    }
                },
                {
                    name: 'æ£€æŸ¥startæ–¹æ³•',
                    test: () => {
                        const file = MP4Box.createFile();
                        return typeof file.start === 'function';
                    }
                },
                {
                    name: 'æ£€æŸ¥getInfoæ–¹æ³•',
                    test: () => {
                        const file = MP4Box.createFile();
                        return typeof file.getInfo === 'function';
                    }
                }
            ];

            tests.forEach(({ name, test }) => {
                try {
                    const result = test();
                    if (result) {
                        log(`âœ… ${name} - é€šè¿‡`, 'success');
                        addStatus('basic-tests', `âœ… ${name}`, 'success');
                    } else {
                        log(`âŒ ${name} - å¤±è´¥`, 'error');
                        addStatus('basic-tests', `âŒ ${name}`, 'error');
                    }
                } catch (error) {
                    log(`âŒ ${name} - é”™è¯¯: ${error.message}`, 'error');
                    addStatus('basic-tests', `âŒ ${name} - ${error.message}`, 'error');
                }
            });
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        document.getElementById('testFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                log(`é€‰æ‹©æ–‡ä»¶: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`, 'info');
                document.getElementById('testBtn').disabled = false;
                testFileData = file;
            } else {
                document.getElementById('testBtn').disabled = true;
                testFileData = null;
            }
        });

        // ç›´æ¥æµ‹è¯•MP4Boxæ–‡ä»¶è§£æ
        async function testFileDirectly() {
            if (!testFileData) {
                log('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            log('=== å¼€å§‹MP4Boxç›´æ¥è§£ææµ‹è¯• ===', 'info');
            
            // é‡ç½®æ‰€æœ‰æ­¥éª¤
            ['step-load', 'step-create', 'step-callbacks', 'step-append', 'step-start', 'step-result'].forEach(id => {
                updateStep(id, '');
            });

            try {
                // æ­¥éª¤1: æ–‡ä»¶åŠ è½½
                updateStep('step-load', 'active');
                log('æ­¥éª¤1: è¯»å–æ–‡ä»¶æ•°æ®...', 'info');
                
                const arrayBuffer = await testFileData.arrayBuffer();
                log(`æ–‡ä»¶è¯»å–æˆåŠŸ: ${arrayBuffer.byteLength} å­—èŠ‚`, 'success');
                updateStep('step-load', 'success');

                // æ­¥éª¤2: åˆ›å»ºMP4Boxå®ä¾‹
                updateStep('step-create', 'active');
                log('æ­¥éª¤2: åˆ›å»ºMP4Boxå®ä¾‹...', 'info');
                
                mp4boxFile = MP4Box.createFile();
                if (!mp4boxFile) {
                    throw new Error('MP4Box.createFile() è¿”å›null');
                }
                log('MP4Boxå®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                updateStep('step-create', 'success');

                // æ­¥éª¤3: è®¾ç½®å›è°ƒ
                updateStep('step-callbacks', 'active');
                log('æ­¥éª¤3: è®¾ç½®å›è°ƒå‡½æ•°...', 'info');
                
                let onReadyCalled = false;
                let onErrorCalled = false;

                mp4boxFile.onReady = function(info) {
                    onReadyCalled = true;
                    log('ğŸ‰ onReadyå›è°ƒè¢«è§¦å‘!', 'success');
                    log(`è§£ææˆåŠŸ! æ‰¾åˆ° ${info.tracks.length} ä¸ªè½¨é“`, 'success');
                    log(`æŒç»­æ—¶é—´: ${info.duration}ms, æ—¶é—´å°ºåº¦: ${info.timescale}`, 'info');
                    
                    updateStep('step-result', 'success');
                    
                    info.tracks.forEach((track, index) => {
                        log(`è½¨é“ ${index + 1}: ${track.type} (${track.codec})`, 'info');
                    });
                };

                mp4boxFile.onError = function(error) {
                    onErrorCalled = true;
                    log(`âŒ onErrorå›è°ƒè¢«è§¦å‘: ${error}`, 'error');
                    updateStep('step-result', 'error');
                };

                mp4boxFile.onSamples = function(id, user, samples) {
                    log(`æ”¶åˆ°è½¨é“ ${id} çš„ ${samples.length} ä¸ªæ ·æœ¬`, 'info');
                };

                log('å›è°ƒå‡½æ•°è®¾ç½®å®Œæˆ', 'success');
                updateStep('step-callbacks', 'success');

                // æ­¥éª¤4: æ·»åŠ æ•°æ®
                updateStep('step-append', 'active');
                log('æ­¥éª¤4: å‘MP4Boxæ·»åŠ æ•°æ®...', 'info');
                
                // è®¾ç½®æ–‡ä»¶å¼€å§‹ä½ç½®
                arrayBuffer.fileStart = 0;
                
                const nextOffset = mp4boxFile.appendBuffer(arrayBuffer);
                log(`æ•°æ®æ·»åŠ æˆåŠŸ, ä¸‹ä¸€ä¸ªåç§»: ${nextOffset}`, 'success');
                updateStep('step-append', 'success');

                // æ­¥éª¤5: å¯åŠ¨è§£æ
                updateStep('step-start', 'active');
                log('æ­¥éª¤5: å¯åŠ¨MP4Boxè§£æ...', 'info');
                
                mp4boxFile.start();
                log('MP4Box.start() è°ƒç”¨å®Œæˆ', 'success');
                updateStep('step-start', 'success');

                // ç­‰å¾…å›è°ƒç»“æœ
                updateStep('step-result', 'active');
                log('ç­‰å¾…è§£æç»“æœ...', 'info');
                
                // è®¾ç½®è¶…æ—¶æ£€æŸ¥
                let timeoutCount = 0;
                const checkResult = () => {
                    timeoutCount++;
                    
                    if (onReadyCalled) {
                        log('âœ… è§£æå®Œå…¨æˆåŠŸ!', 'success');
                        return;
                    }
                    
                    if (onErrorCalled) {
                        log('âŒ è§£æå¤±è´¥', 'error');
                        return;
                    }
                    
                    if (timeoutCount < 10) { // æœ€å¤šç­‰å¾…5ç§’
                        log(`ç­‰å¾…ä¸­... (${timeoutCount}/10)`, 'warning');
                        setTimeout(checkResult, 500);
                    } else {
                        log('âš ï¸ è¶…æ—¶! å°è¯•å¼ºåˆ¶è·å–ä¿¡æ¯...', 'warning');
                        
                        try {
                            const info = mp4boxFile.getInfo && mp4boxFile.getInfo();
                            if (info && info.tracks && info.tracks.length > 0) {
                                log('âœ… å¼ºåˆ¶è·å–ä¿¡æ¯æˆåŠŸ!', 'success');
                                log(`æ‰¾åˆ° ${info.tracks.length} ä¸ªè½¨é“`, 'success');
                                updateStep('step-result', 'success');
                                
                                info.tracks.forEach((track, index) => {
                                    log(`è½¨é“ ${index + 1}: ${track.type} (${track.codec})`, 'info');
                                });
                            } else {
                                log('âŒ å¼ºåˆ¶è·å–ä¿¡æ¯ä¹Ÿå¤±è´¥', 'error');
                                updateStep('step-result', 'error');
                            }
                        } catch (error) {
                            log(`âŒ å¼ºåˆ¶è·å–ä¿¡æ¯å‡ºé”™: ${error.message}`, 'error');
                            updateStep('step-result', 'error');
                        }
                    }
                };
                
                setTimeout(checkResult, 500);

            } catch (error) {
                log(`âŒ æµ‹è¯•è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
                
                // æ ‡è®°å½“å‰æ­¥éª¤ä¸ºé”™è¯¯
                const activeStep = document.querySelector('.step.active');
                if (activeStep) {
                    updateStep(activeStep.id, 'error');
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥MP4Box
        document.addEventListener('DOMContentLoaded', function() {
            log('MP4Boxç›´æ¥æµ‹è¯•å·¥å…·å¯åŠ¨', 'info');
            
            setTimeout(() => {
                if (typeof MP4Box !== 'undefined') {
                    log('âœ… MP4Boxåº“åŠ è½½å®Œæˆ', 'success');
                    checkMP4BoxVersion();
                } else {
                    log('âŒ MP4Boxåº“åŠ è½½å¤±è´¥', 'error');
                    addStatus('mp4box-status', 'âŒ MP4Boxåº“åŠ è½½å¤±è´¥', 'error');
                }
            }, 1000);
        });

        // å…¨å±€é”™è¯¯æ•è·
        window.addEventListener('error', function(e) {
            log(`å…¨å±€é”™è¯¯: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });
    </script>
</body>
</html>