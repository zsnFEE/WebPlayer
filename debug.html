<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ”§ æ’­æ”¾å™¨è¯Šæ–­</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            margin: 0;
        }
        .status { padding: 5px; margin: 5px 0; border-radius: 3px; }
        .success { background: #2d5a2d; }
        .error { background: #5a2d2d; }
        .warning { background: #5a5a2d; }
        .info { background: #2d2d5a; }
        .log { 
            background: #222; 
            padding: 10px; 
            border-radius: 5px; 
            max-height: 300px; 
            overflow-y: auto; 
            white-space: pre-wrap;
            font-size: 12px;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        input[type="file"] {
            margin: 10px 0;
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ æ’­æ”¾å™¨å¿«é€Ÿè¯Šæ–­</h1>
    
    <div id="checks"></div>
    
    <h3>æµ‹è¯•æ–‡ä»¶æ’­æ”¾</h3>
    <input type="file" id="testFile" accept="video/*">
    <button onclick="testBasicVideo()">æµ‹è¯•åŸºç¡€HTML5æ’­æ”¾</button>
    <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    
    <video id="testVideo" controls style="width: 400px; margin: 10px 0; display: none;"></video>
    
    <h3>å®žæ—¶æ—¥å¿—</h3>
    <div id="log" class="log"></div>

    <script>
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        function addStatus(message, type) {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            document.getElementById('checks').appendChild(div);
        }

        // åŸºç¡€æ£€æŸ¥
        function runBasicChecks() {
            log('=== å¼€å§‹åŸºç¡€æ£€æŸ¥ ===');
            
            // æ£€æŸ¥åŸºæœ¬API
            const checks = [
                { name: 'HTML5 Video', test: () => !!document.createElement('video').canPlayType },
                { name: 'Canvas 2D', test: () => !!document.createElement('canvas').getContext('2d') },
                { name: 'WebGL', test: () => !!document.createElement('canvas').getContext('webgl') },
                { name: 'WebGL2', test: () => !!document.createElement('canvas').getContext('webgl2') },
                { name: 'WebGPU', test: () => !!navigator.gpu },
                { name: 'AudioContext', test: () => !!(window.AudioContext || window.webkitAudioContext) },
                { name: 'VideoDecoder', test: () => typeof VideoDecoder !== 'undefined' },
                { name: 'AudioDecoder', test: () => typeof AudioDecoder !== 'undefined' },
                { name: 'OffscreenCanvas', test: () => typeof OffscreenCanvas !== 'undefined' },
                { name: 'SharedArrayBuffer', test: () => typeof SharedArrayBuffer !== 'undefined' },
                { name: 'AudioWorklet', test: () => !!(window.AudioWorklet) },
            ];

            checks.forEach(({ name, test }) => {
                try {
                    const result = test();
                    const status = result ? 'success' : 'error';
                    const icon = result ? 'âœ…' : 'âŒ';
                    addStatus(`${icon} ${name}`, status);
                    log(`${name}: ${result ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`, status);
                } catch (error) {
                    addStatus(`âŒ ${name} (é”™è¯¯: ${error.message})`, 'error');
                    log(`${name}: æ£€æŸ¥å‡ºé”™ - ${error.message}`, 'error');
                }
            });

            // æ£€æŸ¥HTTPS
            const isHTTPS = location.protocol === 'https:';
            const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            if (!isHTTPS && !isLocalhost) {
                addStatus('âš ï¸ éžHTTPSçŽ¯å¢ƒï¼ŒæŸäº›APIå¯èƒ½å—é™', 'warning');
                log('è­¦å‘Š: éžHTTPSçŽ¯å¢ƒï¼ŒWebCodecsç­‰APIå¯èƒ½ä¸å¯ç”¨', 'warning');
            } else {
                addStatus('âœ… å®‰å…¨çŽ¯å¢ƒ (HTTPS/localhost)', 'success');
                log('çŽ¯å¢ƒæ£€æŸ¥: å®‰å…¨', 'success');
            }

            log('=== åŸºç¡€æ£€æŸ¥å®Œæˆ ===');
        }

        // æµ‹è¯•åŸºç¡€è§†é¢‘æ’­æ”¾
        function testBasicVideo() {
            const fileInput = document.getElementById('testFile');
            const video = document.getElementById('testVideo');
            
            if (!fileInput.files[0]) {
                log('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶', 'error');
                return;
            }

            const file = fileInput.files[0];
            log(`æµ‹è¯•æ–‡ä»¶: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`, 'info');
            
            try {
                const url = URL.createObjectURL(file);
                video.src = url;
                video.style.display = 'block';
                
                video.onloadedmetadata = () => {
                    log(`âœ… æ–‡ä»¶åŠ è½½æˆåŠŸ: ${video.videoWidth}x${video.videoHeight}, æ—¶é•¿: ${video.duration.toFixed(2)}s`, 'success');
                    addStatus(`âœ… HTML5è§†é¢‘æ’­æ”¾æ­£å¸¸`, 'success');
                };
                
                video.onplay = () => {
                    log('â–¶ï¸ è§†é¢‘å¼€å§‹æ’­æ”¾', 'success');
                };
                
                video.onpause = () => {
                    log('â¸ï¸ è§†é¢‘æš‚åœ', 'info');
                };
                
                video.onerror = (e) => {
                    log(`âŒ è§†é¢‘æ’­æ”¾é”™è¯¯: ${e.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    addStatus(`âŒ HTML5è§†é¢‘æ’­æ”¾å¤±è´¥`, 'error');
                };
                
                video.oncanplay = () => {
                    log('âœ… è§†é¢‘å¯ä»¥æ’­æ”¾', 'success');
                };
                
            } catch (error) {
                log(`åˆ›å»ºè§†é¢‘URLå¤±è´¥: ${error.message}`, 'error');
                addStatus(`âŒ æ–‡ä»¶URLåˆ›å»ºå¤±è´¥`, 'error');
            }
        }

        // æ£€æŸ¥ä¸»æ’­æ”¾å™¨
        async function checkMainPlayer() {
            log('=== æ£€æŸ¥ä¸»æ’­æ”¾å™¨çŠ¶æ€ ===');
            
            try {
                // å°è¯•è®¿é—®ä¸»æ’­æ”¾å™¨
                const response = await fetch('./');
                if (response.ok) {
                    log('âœ… ä¸»é¡µé¢å¯è®¿é—®', 'success');
                    addStatus('âœ… ä¸»é¡µé¢æ­£å¸¸', 'success');
                } else {
                    log(`âŒ ä¸»é¡µé¢è®¿é—®å¤±è´¥: ${response.status}`, 'error');
                    addStatus('âŒ ä¸»é¡µé¢è®¿é—®å¤±è´¥', 'error');
                }
            } catch (error) {
                log(`ä¸»é¡µé¢æ£€æŸ¥é”™è¯¯: ${error.message}`, 'error');
                addStatus('âŒ ä¸»é¡µé¢æ£€æŸ¥å¤±è´¥', 'error');
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®ç«¯å£
            const currentPort = location.port;
            if (currentPort !== '9000') {
                log(`âš ï¸ å½“å‰ç«¯å£: ${currentPort || 'é»˜è®¤'}, æŽ¨èç«¯å£: 9000`, 'warning');
                addStatus('âš ï¸ ç«¯å£å¯èƒ½ä¸æ­£ç¡®', 'warning');
            } else {
                log('âœ… ç«¯å£æ­£ç¡®: 9000', 'success');
                addStatus('âœ… ç«¯å£æ­£ç¡®', 'success');
            }
        }

        // é¡µé¢åŠ è½½å®ŒæˆåŽè‡ªåŠ¨è¿è¡Œæ£€æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            log('æ’­æ”¾å™¨è¯Šæ–­å·¥å…·å¯åŠ¨', 'info');
            runBasicChecks();
            checkMainPlayer();
            
            // æ·»åŠ å»ºè®®
            setTimeout(() => {
                log('\n=== è¯Šæ–­å»ºè®® ===', 'info');
                log('1. ç¡®ä¿åœ¨Chrome 94+æˆ–Edge 94+æµè§ˆå™¨ä¸­è¿è¡Œ', 'info');
                log('2. ä½¿ç”¨ npm run dev å¯åŠ¨å¼€å‘æœåŠ¡å™¨', 'info');
                log('3. è®¿é—® http://localhost:9000', 'info');
                log('4. å¦‚æžœåŸºç¡€HTML5æ’­æ”¾æ­£å¸¸ï¼Œé—®é¢˜å¯èƒ½åœ¨WebCodecs/WebGPUåˆå§‹åŒ–', 'info');
                log('5. æŸ¥çœ‹æµè§ˆå™¨Consoleæ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯', 'info');
            }, 1000);
        });

        // å…¨å±€é”™è¯¯æ•èŽ·
        window.addEventListener('error', (e) => {
            log(`å…¨å±€é”™è¯¯: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });
    </script>
</body>
</html>