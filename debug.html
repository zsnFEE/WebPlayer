<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug WebAV Player</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
        .error { color: #f00; background: #300; padding: 10px; margin: 5px 0; }
        .success { color: #0f0; background: #030; padding: 10px; margin: 5px 0; }
        .warning { color: #ff0; background: #330; padding: 10px; margin: 5px 0; }
        pre { background: #111; padding: 15px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔍 WebAV Player 错误诊断</h1>
    <div id="status">正在检查...</div>
    <div id="errors"></div>
    
    <script>
        const statusEl = document.getElementById('status');
        const errorsEl = document.getElementById('errors');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            errorsEl.appendChild(div);
            console.log(message);
        }
        
        function updateStatus(message) {
            statusEl.innerHTML = message;
        }
        
        // 捕获所有错误
        window.addEventListener('error', (e) => {
            log(`❌ ERROR: ${e.message}<br>文件: ${e.filename}<br>行号: ${e.lineno}<br>列号: ${e.colno}<br>堆栈: ${e.error?.stack || 'N/A'}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            log(`❌ PROMISE REJECTION: ${e.reason}<br>堆栈: ${e.reason?.stack || 'N/A'}`, 'error');
        });
        
        async function diagnose() {
            updateStatus('🔍 开始诊断...');
            
            try {
                // 1. 检查基础环境
                log('=== 基础环境检查 ===');
                log(`✓ Node 环境: ${typeof process !== 'undefined' ? 'YES' : 'NO'}`);
                log(`✓ 浏览器环境: ${typeof window !== 'undefined' ? 'YES' : 'NO'}`);
                log(`✓ ES Modules: ${typeof import !== 'undefined' ? 'YES' : 'NO'}`);
                log(`✓ WebAssembly: ${typeof WebAssembly !== 'undefined' ? 'YES' : 'NO'}`);
                log(`✓ SharedArrayBuffer: ${typeof SharedArrayBuffer !== 'undefined' ? 'YES' : 'NO'}`);
                
                // 2. 检查polyfills
                log('<br>=== Polyfills 检查 ===');
                log(`✓ crypto: ${typeof crypto !== 'undefined' ? 'YES' : 'NO'}`);
                log(`✓ crypto.getRandomValues: ${typeof crypto?.getRandomValues === 'function' ? 'YES' : 'NO'}`);
                log(`✓ global: ${typeof global !== 'undefined' ? 'YES' : 'NO'}`);
                log(`✓ process: ${typeof process !== 'undefined' ? 'YES' : 'NO'}`);
                
                // 测试crypto
                if (crypto && crypto.getRandomValues) {
                    const testArray = new Uint8Array(4);
                    crypto.getRandomValues(testArray);
                    log(`✓ crypto.getRandomValues 工作正常: [${Array.from(testArray)}]`, 'success');
                } else {
                    log('❌ crypto.getRandomValues 不可用', 'error');
                }
                
                // 3. 尝试加载模块
                log('<br>=== 模块加载测试 ===');
                
                try {
                    updateStatus('📦 正在加载 polyfills...');
                    await import('/src/utils/polyfills.js');
                    log('✓ polyfills.js 加载成功', 'success');
                } catch (e) {
                    log(`❌ polyfills.js 加载失败: ${e.message}<br>堆栈: ${e.stack}`, 'error');
                }
                
                try {
                    updateStatus('📦 正在加载 player...');
                    const playerModule = await import('/src/player.js');
                    log('✓ player.js 加载成功', 'success');
                    log(`✓ WebAVPlayer 类可用: ${typeof playerModule.WebAVPlayer === 'function' ? 'YES' : 'NO'}`);
                } catch (e) {
                    log(`❌ player.js 加载失败: ${e.message}<br>堆栈: ${e.stack}`, 'error');
                }
                
                // 4. 尝试初始化播放器
                log('<br>=== 播放器初始化测试 ===');
                try {
                    updateStatus('🎮 正在初始化播放器...');
                    
                    // 创建测试canvas
                    const canvas = document.createElement('canvas');
                    canvas.width = 800;
                    canvas.height = 600;
                    
                    const { WebAVPlayer } = await import('/src/player.js');
                    const player = new WebAVPlayer(canvas);
                    log('✓ WebAVPlayer 实例化成功', 'success');
                    
                    updateStatus('✅ 诊断完成');
                    
                } catch (e) {
                    log(`❌ 播放器初始化失败: ${e.message}<br>堆栈: ${e.stack}`, 'error');
                    updateStatus('❌ 诊断发现问题');
                }
                
            } catch (e) {
                log(`❌ 诊断过程出错: ${e.message}<br>堆栈: ${e.stack}`, 'error');
                updateStatus('❌ 诊断失败');
            }
        }
        
        // 开始诊断
        diagnose();
    </script>
</body>
</html>