<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ å…¨é¢æ’­æ”¾è¯Šæ–­</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
            margin: 0;
        }
        .section {
            background: #111;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #333;
        }
        .log { 
            background: #000; 
            padding: 10px; 
            border-radius: 3px; 
            max-height: 300px; 
            overflow-y: auto; 
            white-space: pre-wrap;
            font-size: 11px;
            border: 1px solid #333;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            margin: 3px;
            font-size: 12px;
        }
        button:hover { background: #1976D2; }
        button:disabled { background: #666; cursor: not-allowed; }
        input[type="file"] {
            margin: 10px 0;
            padding: 8px;
            background: #333;
            border: 1px solid #666;
            color: white;
            border-radius: 3px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        .status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 2px;
            font-size: 10px;
        }
        .status.ok { background: #4CAF50; color: white; }
        .status.fail { background: #f44336; color: white; }
        .status.pending { background: #ff9800; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ”§ å®Œæ•´æ’­æ”¾æµç¨‹è¯Šæ–­å·¥å…·</h1>
    <p>é€æ­¥æ£€æŸ¥æ¯ä¸ªç»„ä»¶å’Œæµç¨‹</p>

    <!-- æµè§ˆå™¨æ”¯æŒæ£€æŸ¥ -->
    <div class="section">
        <h3>ğŸŒ æµè§ˆå™¨æ”¯æŒæ£€æŸ¥</h3>
        <div id="browser-support"></div>
        <button onclick="checkBrowserSupport()">æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ</button>
    </div>

    <!-- æ–‡ä»¶ä¸Šä¼ å’ŒåŸºæœ¬ä¿¡æ¯ -->
    <div class="section">
        <h3>ğŸ“ æ–‡ä»¶æµ‹è¯•</h3>
        <input type="file" id="testFile" accept="video/*">
        <button onclick="runComprehensiveTest()" id="testBtn" disabled>å¼€å§‹å®Œæ•´æµ‹è¯•</button>
        <button onclick="testWithNativeVideo()" id="nativeBtn" disabled>æµ‹è¯•åŸç”Ÿæ’­æ”¾</button>
        <div id="file-info"></div>
    </div>

    <!-- æ­¥éª¤è¿½è¸ª -->
    <div class="section">
        <h3>ğŸ“‹ æµç¨‹æ­¥éª¤è¿½è¸ª</h3>
        <div id="step-tracker">
            <div>1. <span class="status pending">æ–‡ä»¶åŠ è½½</span></div>
            <div>2. <span class="status pending">MP4è§£æ</span></div>
            <div>3. <span class="status pending">MediaInfoæå–</span></div>
            <div>4. <span class="status pending">è§£ç å™¨åˆå§‹åŒ–</span></div>
            <div>5. <span class="status pending">æ ·æœ¬æå–</span></div>
            <div>6. <span class="status pending">è§£ç å¤„ç†</span></div>
            <div>7. <span class="status pending">æ¸²æŸ“æ˜¾ç¤º</span></div>
            <div>8. <span class="status pending">éŸ³é¢‘æ’­æ”¾</span></div>
        </div>
    </div>

    <!-- è¯¦ç»†æ—¥å¿— -->
    <div class="section">
        <h3>ğŸ“Š è¯¦ç»†è¯Šæ–­æ—¥å¿—</h3>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <button onclick="exportLog()">å¯¼å‡ºæ—¥å¿—</button>
        <div id="log" class="log">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
    </div>

    <!-- åŸç”Ÿè§†é¢‘æµ‹è¯•åŒºåŸŸ -->
    <div class="section" id="native-test" style="display: none;">
        <h3>ğŸ¬ åŸç”ŸHTML5è§†é¢‘æµ‹è¯•</h3>
        <video id="nativeVideo" controls width="400" height="300"></video>
        <div id="native-info"></div>
    </div>

    <script type="module">
        let testFile = null;
        let player = null;
        let testLog = [];

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#2196F3',
                success: '#4CAF50', 
                error: '#f44336',
                warning: '#ff9800'
            };
            
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push({timestamp, message, type});
            
            logEl.innerHTML += `<span style="color: ${colors[type]}">${logEntry}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStep(stepNum, status) {
            const steps = document.querySelectorAll('#step-tracker .status');
            if (steps[stepNum - 1]) {
                steps[stepNum - 1].className = `status ${status}`;
                steps[stepNum - 1].textContent = status === 'ok' ? 'âœ…' : status === 'fail' ? 'âŒ' : 'â³';
            }
        }

        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
            testLog = [];
        };

        window.exportLog = function() {
            const logText = testLog.map(entry => 
                `[${entry.timestamp}] [${entry.type.toUpperCase()}] ${entry.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `webav-debug-${Date.now()}.log`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // æµè§ˆå™¨æ”¯æŒæ£€æŸ¥
        window.checkBrowserSupport = function() {
            const support = document.getElementById('browser-support');
            support.innerHTML = '';
            
            const checks = [
                {name: 'WebCodecs VideoDecoder', check: () => 'VideoDecoder' in window},
                {name: 'WebCodecs AudioDecoder', check: () => 'AudioDecoder' in window},
                {name: 'WebGPU', check: () => 'gpu' in navigator},
                {name: 'WebGL2', check: () => {
                    const canvas = document.createElement('canvas');
                    return !!canvas.getContext('webgl2');
                }},
                {name: 'AudioContext', check: () => 'AudioContext' in window || 'webkitAudioContext' in window},
                {name: 'AudioWorklet', check: () => 'AudioWorklet' in window},
                {name: 'SharedArrayBuffer', check: () => 'SharedArrayBuffer' in window},
                {name: 'OffscreenCanvas', check: () => 'OffscreenCanvas' in window},
                {name: 'MP4Box (script)', check: () => typeof MP4Box !== 'undefined'},
            ];
            
            checks.forEach(({name, check}) => {
                const result = check();
                const status = result ? 'ok' : 'fail';
                support.innerHTML += `<div>${name}: <span class="status ${status}">${result ? 'âœ…' : 'âŒ'}</span></div>`;
                log(`Browser support ${name}: ${result}`, result ? 'success' : 'warning');
            });
        };

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        document.getElementById('testFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                testFile = file;
                document.getElementById('testBtn').disabled = false;
                document.getElementById('nativeBtn').disabled = false;
                
                const info = document.getElementById('file-info');
                info.innerHTML = `
                    <div>æ–‡ä»¶å: ${file.name}</div>
                    <div>å¤§å°: ${(file.size/1024/1024).toFixed(2)}MB</div>
                    <div>ç±»å‹: ${file.type}</div>
                    <div>æœ€åä¿®æ”¹: ${file.lastModified ? new Date(file.lastModified).toLocaleString() : 'æœªçŸ¥'}</div>
                `;
                
                log(`æ–‡ä»¶é€‰æ‹©: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`, 'info');
            }
        });

        // åŸç”Ÿè§†é¢‘æµ‹è¯•
        window.testWithNativeVideo = function() {
            if (!testFile) return;
            
            log('=== å¼€å§‹åŸç”ŸHTML5è§†é¢‘æµ‹è¯• ===', 'info');
            document.getElementById('native-test').style.display = 'block';
            
            const video = document.getElementById('nativeVideo');
            const url = URL.createObjectURL(testFile);
            
            video.onloadedmetadata = function() {
                const info = document.getElementById('native-info');
                info.innerHTML = `
                    <div>æ—¶é•¿: ${video.duration.toFixed(2)}ç§’</div>
                    <div>å°ºå¯¸: ${video.videoWidth}x${video.videoHeight}</div>
                    <div>å¯æ’­æ”¾: ${video.readyState >= 3 ? 'æ˜¯' : 'å¦'}</div>
                `;
                log(`åŸç”Ÿè§†é¢‘åŠ è½½æˆåŠŸ: ${video.duration.toFixed(2)}s, ${video.videoWidth}x${video.videoHeight}`, 'success');
            };
            
            video.onerror = function(e) {
                log(`åŸç”Ÿè§†é¢‘åŠ è½½å¤±è´¥: ${e.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            };
            
            video.oncanplay = function() {
                log('åŸç”Ÿè§†é¢‘å¯ä»¥æ’­æ”¾', 'success');
            };
            
            video.src = url;
        };

        // å®Œæ•´æµ‹è¯•æµç¨‹
        window.runComprehensiveTest = async function() {
            if (!testFile) {
                log('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            log('=== å¼€å§‹å®Œæ•´æ’­æ”¾æµç¨‹æµ‹è¯• ===', 'info');
            
            try {
                // æ­¥éª¤1: æ–‡ä»¶åŠ è½½
                updateStep(1, 'pending');
                log('æ­¥éª¤1: è¯»å–æ–‡ä»¶æ•°æ®...', 'info');
                const arrayBuffer = await testFile.arrayBuffer();
                log(`æ–‡ä»¶è¯»å–æˆåŠŸ: ${arrayBuffer.byteLength} å­—èŠ‚`, 'success');
                updateStep(1, 'ok');

                // æ­¥éª¤2: MP4è§£æ
                updateStep(2, 'pending');
                log('æ­¥éª¤2: åˆå§‹åŒ–MP4è§£æå™¨...', 'info');
                
                // åŠ¨æ€å¯¼å…¥æ’­æ”¾å™¨
                const module = await import('./main.js');
                const { WebAVPlayer } = module;
                
                // åˆ›å»ºcanvaså’Œæ’­æ”¾å™¨
                const canvas = document.createElement('canvas');
                canvas.width = 800;
                canvas.height = 600;
                canvas.style.background = '#000';
                canvas.style.border = '1px solid #333';
                document.body.appendChild(canvas);
                
                player = new WebAVPlayer(canvas);
                
                // è®¾ç½®è¯¦ç»†çš„å›è°ƒç›‘å¬
                player.onMediaReady = () => {
                    log('ğŸ‰ Player onMediaReady callback triggered!', 'success');
                    updateStep(3, 'ok');
                };
                
                player.onError = (error) => {
                    log(`âŒ Player error: ${error}`, 'error');
                };
                
                player.onTimeUpdate = (time) => {
                    log(`â° Time update: ${time.toFixed(2)}s`, 'info');
                };
                
                // æ­¥éª¤3: åˆå§‹åŒ–æ’­æ”¾å™¨
                log('æ­¥éª¤3: åˆå§‹åŒ–æ’­æ”¾å™¨...', 'info');
                await player.initialize();
                log('æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ', 'success');
                
                // æ­¥éª¤4: åŠ è½½æ–‡ä»¶
                updateStep(4, 'pending');
                log('æ­¥éª¤4: åŠ è½½æ–‡ä»¶åˆ°æ’­æ”¾å™¨...', 'info');
                await player.loadFile(testFile);
                log('æ–‡ä»¶åŠ è½½å®Œæˆ', 'success');
                updateStep(4, 'ok');
                
                // ç­‰å¾…ä¸€æ®µæ—¶é—´æ£€æŸ¥çŠ¶æ€
                setTimeout(() => {
                    const state = player.getState();
                    log('=== æ’­æ”¾å™¨çŠ¶æ€æ£€æŸ¥ ===', 'info');
                    log(`Playing: ${state.playing}`, state.playing ? 'success' : 'warning');
                    log(`Duration: ${state.duration}`, state.duration > 0 ? 'success' : 'warning');
                    log(`Current Time: ${state.currentTime}`, 'info');
                    log(`Has MediaInfo: ${!!state.mediaInfo}`, state.mediaInfo ? 'success' : 'error');
                    log(`Has Decoder: ${state.hasDecoder}`, state.hasDecoder ? 'success' : 'error');
                    log(`Has Renderer: ${state.hasRenderer}`, state.hasRenderer ? 'success' : 'error');
                    log(`Has Parser: ${state.hasParser}`, state.hasParser ? 'success' : 'error');
                    
                    if (state.mediaInfo) {
                        updateStep(3, 'ok');
                        log(`Video: ${state.mediaInfo.hasVideo}, Audio: ${state.mediaInfo.hasAudio}`, 'info');
                    } else {
                        updateStep(3, 'fail');
                        log('MediaInfoæœªèƒ½è·å–ï¼Œå¯èƒ½æ˜¯MP4è§£æå¤±è´¥', 'error');
                    }
                    
                    // å°è¯•æ’­æ”¾
                    updateStep(5, 'pending');
                    log('å°è¯•å¯åŠ¨æ’­æ”¾...', 'info');
                    player.play().then(() => {
                        log('æ’­æ”¾å‘½ä»¤æ‰§è¡ŒæˆåŠŸ', 'success');
                        updateStep(5, 'ok');
                        
                        // æ£€æŸ¥æ˜¯å¦çœŸçš„åœ¨æ’­æ”¾
                        setTimeout(() => {
                            const newState = player.getState();
                            if (newState.playing) {
                                log('âœ… æ’­æ”¾å™¨çŠ¶æ€ç¡®è®¤ä¸ºæ’­æ”¾ä¸­', 'success');
                                updateStep(6, 'ok');
                                updateStep(7, 'ok');
                                updateStep(8, 'ok');
                            } else {
                                log('âš ï¸ æ’­æ”¾å™¨çŠ¶æ€ä»æœªæ’­æ”¾', 'warning');
                                updateStep(6, 'fail');
                            }
                        }, 2000);
                    }).catch(error => {
                        log(`æ’­æ”¾å¤±è´¥: ${error}`, 'error');
                        updateStep(5, 'fail');
                    });
                }, 3000);
                
            } catch (error) {
                log(`æµ‹è¯•è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
                
                // æ ‡è®°å¤±è´¥çš„æ­¥éª¤
                for (let i = 1; i <= 8; i++) {
                    if (document.querySelectorAll('#step-tracker .status')[i-1].classList.contains('pending')) {
                        updateStep(i, 'fail');
                        break;
                    }
                }
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        window.addEventListener('load', () => {
            log('è¯Šæ–­å·¥å…·å¯åŠ¨', 'info');
            setTimeout(checkBrowserSupport, 500);
        });

        // å…¨å±€é”™è¯¯æ•è·
        window.addEventListener('error', function(e) {
            log(`å…¨å±€é”™è¯¯: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            log(`æœªå¤„ç†çš„Promiseæ‹’ç»: ${e.reason}`, 'error');
        });
    </script>

    <!-- åŠ è½½MP4Boxç”¨äºæ£€æŸ¥ -->
    <script src="https://unpkg.com/mp4box@0.5.2/dist/mp4box.all.min.js"></script>
</body>
</html>