<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 全面播放诊断</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
            margin: 0;
        }
        .section {
            background: #111;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #333;
        }
        .log { 
            background: #000; 
            padding: 10px; 
            border-radius: 3px; 
            max-height: 300px; 
            overflow-y: auto; 
            white-space: pre-wrap;
            font-size: 11px;
            border: 1px solid #333;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            margin: 3px;
            font-size: 12px;
        }
        button:hover { background: #1976D2; }
        button:disabled { background: #666; cursor: not-allowed; }
        input[type="file"] {
            margin: 10px 0;
            padding: 8px;
            background: #333;
            border: 1px solid #666;
            color: white;
            border-radius: 3px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        .status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 2px;
            font-size: 10px;
        }
        .status.ok { background: #4CAF50; color: white; }
        .status.fail { background: #f44336; color: white; }
        .status.pending { background: #ff9800; color: white; }
    </style>
</head>
<body>
    <h1>🔧 完整播放流程诊断工具</h1>
    <p>逐步检查每个组件和流程</p>

    <!-- 浏览器支持检查 -->
    <div class="section">
        <h3>🌐 浏览器支持检查</h3>
        <div id="browser-support"></div>
        <button onclick="checkBrowserSupport()">检查浏览器支持</button>
    </div>

    <!-- 文件上传和基本信息 -->
    <div class="section">
        <h3>📁 文件测试</h3>
        <input type="file" id="testFile" accept="video/*">
        <button onclick="runComprehensiveTest()" id="testBtn" disabled>开始完整测试</button>
        <button onclick="testWithNativeVideo()" id="nativeBtn" disabled>测试原生播放</button>
        <div id="file-info"></div>
    </div>

    <!-- 步骤追踪 -->
    <div class="section">
        <h3>📋 流程步骤追踪</h3>
        <div id="step-tracker">
            <div>1. <span class="status pending">文件加载</span></div>
            <div>2. <span class="status pending">MP4解析</span></div>
            <div>3. <span class="status pending">MediaInfo提取</span></div>
            <div>4. <span class="status pending">解码器初始化</span></div>
            <div>5. <span class="status pending">样本提取</span></div>
            <div>6. <span class="status pending">解码处理</span></div>
            <div>7. <span class="status pending">渲染显示</span></div>
            <div>8. <span class="status pending">音频播放</span></div>
        </div>
    </div>

    <!-- 详细日志 -->
    <div class="section">
        <h3>📊 详细诊断日志</h3>
        <button onclick="clearLog()">清除日志</button>
        <button onclick="exportLog()">导出日志</button>
        <div id="log" class="log">等待测试开始...</div>
    </div>

    <!-- 原生视频测试区域 -->
    <div class="section" id="native-test" style="display: none;">
        <h3>🎬 原生HTML5视频测试</h3>
        <video id="nativeVideo" controls width="400" height="300"></video>
        <div id="native-info"></div>
    </div>

    <script type="module">
        let testFile = null;
        let player = null;
        let testLog = [];

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#2196F3',
                success: '#4CAF50', 
                error: '#f44336',
                warning: '#ff9800'
            };
            
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push({timestamp, message, type});
            
            logEl.innerHTML += `<span style="color: ${colors[type]}">${logEntry}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStep(stepNum, status) {
            const steps = document.querySelectorAll('#step-tracker .status');
            if (steps[stepNum - 1]) {
                steps[stepNum - 1].className = `status ${status}`;
                steps[stepNum - 1].textContent = status === 'ok' ? '✅' : status === 'fail' ? '❌' : '⏳';
            }
        }

        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
            testLog = [];
        };

        window.exportLog = function() {
            const logText = testLog.map(entry => 
                `[${entry.timestamp}] [${entry.type.toUpperCase()}] ${entry.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `webav-debug-${Date.now()}.log`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // 浏览器支持检查
        window.checkBrowserSupport = function() {
            const support = document.getElementById('browser-support');
            support.innerHTML = '';
            
            const checks = [
                {name: 'WebCodecs VideoDecoder', check: () => 'VideoDecoder' in window},
                {name: 'WebCodecs AudioDecoder', check: () => 'AudioDecoder' in window},
                {name: 'WebGPU', check: () => 'gpu' in navigator},
                {name: 'WebGL2', check: () => {
                    const canvas = document.createElement('canvas');
                    return !!canvas.getContext('webgl2');
                }},
                {name: 'AudioContext', check: () => 'AudioContext' in window || 'webkitAudioContext' in window},
                {name: 'AudioWorklet', check: () => 'AudioWorklet' in window},
                {name: 'SharedArrayBuffer', check: () => 'SharedArrayBuffer' in window},
                {name: 'OffscreenCanvas', check: () => 'OffscreenCanvas' in window},
                {name: 'MP4Box (script)', check: () => typeof MP4Box !== 'undefined'},
            ];
            
            checks.forEach(({name, check}) => {
                const result = check();
                const status = result ? 'ok' : 'fail';
                support.innerHTML += `<div>${name}: <span class="status ${status}">${result ? '✅' : '❌'}</span></div>`;
                log(`Browser support ${name}: ${result}`, result ? 'success' : 'warning');
            });
        };

        // 文件选择处理
        document.getElementById('testFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                testFile = file;
                document.getElementById('testBtn').disabled = false;
                document.getElementById('nativeBtn').disabled = false;
                
                const info = document.getElementById('file-info');
                info.innerHTML = `
                    <div>文件名: ${file.name}</div>
                    <div>大小: ${(file.size/1024/1024).toFixed(2)}MB</div>
                    <div>类型: ${file.type}</div>
                    <div>最后修改: ${file.lastModified ? new Date(file.lastModified).toLocaleString() : '未知'}</div>
                `;
                
                log(`文件选择: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`, 'info');
            }
        });

        // 原生视频测试
        window.testWithNativeVideo = function() {
            if (!testFile) return;
            
            log('=== 开始原生HTML5视频测试 ===', 'info');
            document.getElementById('native-test').style.display = 'block';
            
            const video = document.getElementById('nativeVideo');
            const url = URL.createObjectURL(testFile);
            
            video.onloadedmetadata = function() {
                const info = document.getElementById('native-info');
                info.innerHTML = `
                    <div>时长: ${video.duration.toFixed(2)}秒</div>
                    <div>尺寸: ${video.videoWidth}x${video.videoHeight}</div>
                    <div>可播放: ${video.readyState >= 3 ? '是' : '否'}</div>
                `;
                log(`原生视频加载成功: ${video.duration.toFixed(2)}s, ${video.videoWidth}x${video.videoHeight}`, 'success');
            };
            
            video.onerror = function(e) {
                log(`原生视频加载失败: ${e.message || '未知错误'}`, 'error');
            };
            
            video.oncanplay = function() {
                log('原生视频可以播放', 'success');
            };
            
            video.src = url;
        };

        // 完整测试流程
        window.runComprehensiveTest = async function() {
            if (!testFile) {
                log('请先选择文件', 'error');
                return;
            }

            log('=== 开始完整播放流程测试 ===', 'info');
            
            try {
                // 步骤1: 文件加载
                updateStep(1, 'pending');
                log('步骤1: 读取文件数据...', 'info');
                const arrayBuffer = await testFile.arrayBuffer();
                log(`文件读取成功: ${arrayBuffer.byteLength} 字节`, 'success');
                updateStep(1, 'ok');

                // 步骤2: MP4解析
                updateStep(2, 'pending');
                log('步骤2: 初始化MP4解析器...', 'info');
                
                // 动态导入播放器
                const module = await import('./main.js');
                const { WebAVPlayer } = module;
                
                // 创建canvas和播放器
                const canvas = document.createElement('canvas');
                canvas.width = 800;
                canvas.height = 600;
                canvas.style.background = '#000';
                canvas.style.border = '1px solid #333';
                document.body.appendChild(canvas);
                
                player = new WebAVPlayer(canvas);
                
                // 设置详细的回调监听
                player.onMediaReady = () => {
                    log('🎉 Player onMediaReady callback triggered!', 'success');
                    updateStep(3, 'ok');
                };
                
                player.onError = (error) => {
                    log(`❌ Player error: ${error}`, 'error');
                };
                
                player.onTimeUpdate = (time) => {
                    log(`⏰ Time update: ${time.toFixed(2)}s`, 'info');
                };
                
                // 步骤3: 初始化播放器
                log('步骤3: 初始化播放器...', 'info');
                await player.initialize();
                log('播放器初始化完成', 'success');
                
                // 步骤4: 加载文件
                updateStep(4, 'pending');
                log('步骤4: 加载文件到播放器...', 'info');
                await player.loadFile(testFile);
                log('文件加载完成', 'success');
                updateStep(4, 'ok');
                
                // 等待一段时间检查状态
                setTimeout(() => {
                    const state = player.getState();
                    log('=== 播放器状态检查 ===', 'info');
                    log(`Playing: ${state.playing}`, state.playing ? 'success' : 'warning');
                    log(`Duration: ${state.duration}`, state.duration > 0 ? 'success' : 'warning');
                    log(`Current Time: ${state.currentTime}`, 'info');
                    log(`Has MediaInfo: ${!!state.mediaInfo}`, state.mediaInfo ? 'success' : 'error');
                    log(`Has Decoder: ${state.hasDecoder}`, state.hasDecoder ? 'success' : 'error');
                    log(`Has Renderer: ${state.hasRenderer}`, state.hasRenderer ? 'success' : 'error');
                    log(`Has Parser: ${state.hasParser}`, state.hasParser ? 'success' : 'error');
                    
                    if (state.mediaInfo) {
                        updateStep(3, 'ok');
                        log(`Video: ${state.mediaInfo.hasVideo}, Audio: ${state.mediaInfo.hasAudio}`, 'info');
                    } else {
                        updateStep(3, 'fail');
                        log('MediaInfo未能获取，可能是MP4解析失败', 'error');
                    }
                    
                    // 尝试播放
                    updateStep(5, 'pending');
                    log('尝试启动播放...', 'info');
                    player.play().then(() => {
                        log('播放命令执行成功', 'success');
                        updateStep(5, 'ok');
                        
                        // 检查是否真的在播放
                        setTimeout(() => {
                            const newState = player.getState();
                            if (newState.playing) {
                                log('✅ 播放器状态确认为播放中', 'success');
                                updateStep(6, 'ok');
                                updateStep(7, 'ok');
                                updateStep(8, 'ok');
                            } else {
                                log('⚠️ 播放器状态仍未播放', 'warning');
                                updateStep(6, 'fail');
                            }
                        }, 2000);
                    }).catch(error => {
                        log(`播放失败: ${error}`, 'error');
                        updateStep(5, 'fail');
                    });
                }, 3000);
                
            } catch (error) {
                log(`测试过程出错: ${error.message}`, 'error');
                console.error('详细错误:', error);
                
                // 标记失败的步骤
                for (let i = 1; i <= 8; i++) {
                    if (document.querySelectorAll('#step-tracker .status')[i-1].classList.contains('pending')) {
                        updateStep(i, 'fail');
                        break;
                    }
                }
            }
        };

        // 页面加载完成后自动检查浏览器支持
        window.addEventListener('load', () => {
            log('诊断工具启动', 'info');
            setTimeout(checkBrowserSupport, 500);
        });

        // 全局错误捕获
        window.addEventListener('error', function(e) {
            log(`全局错误: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            log(`未处理的Promise拒绝: ${e.reason}`, 'error');
        });
    </script>

    <!-- 加载MP4Box用于检查 -->
    <script src="https://unpkg.com/mp4box@0.5.2/dist/mp4box.all.min.js"></script>
</body>
</html>