<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔑 Keyframe 诊断工具</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .section {
            background: #161b22;
            border: 1px solid #30363d;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
        }
        h2 {
            color: #58a6ff;
            margin-top: 0;
        }
        button {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #2ea043; }
        button:disabled { background: #484f58; cursor: not-allowed; }
        input[type="file"] {
            margin: 10px 0;
            padding: 8px;
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            border-radius: 6px;
            width: 100%;
        }
        .log {
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 15px;
            border-radius: 6px;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }
        .keyframe-list {
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 15px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }
        .keyframe-item {
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .keyframe-item.key {
            background: #0f2419;
            border-left-color: #238636;
        }
        .keyframe-item.delta {
            background: #1c2128;
            border-left-color: #656d76;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .stat-box {
            background: #21262d;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #58a6ff;
        }
        .error { color: #f85149; }
        .success { color: #56d364; }
        .warning { color: #e3b341; }
        .info { color: #58a6ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔑 Keyframe 诊断工具</h1>
        <p>专门分析MP4文件的关键帧问题</p>

        <div class="section">
            <h2>📁 文件选择</h2>
            <input type="file" id="videoFile" accept="video/*">
            <button onclick="analyzeKeyframes()" id="analyzeBtn" disabled>🔍 分析关键帧</button>
            <button onclick="clearLog()">🗑️ 清除日志</button>
        </div>

        <div class="section">
            <h2>📊 关键帧统计</h2>
            <div class="stats" id="stats">
                <div class="stat-box">
                    <div class="stat-value" id="totalFrames">0</div>
                    <div>总帧数</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="keyFrames">0</div>
                    <div>关键帧</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="deltaFrames">0</div>
                    <div>Delta帧</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="keyframeInterval">0</div>
                    <div>关键帧间隔</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>🎬 关键帧列表</h2>
            <div class="keyframe-list" id="keyframeList">
                等待分析...
            </div>
        </div>

        <div class="section">
            <h2>📝 详细日志</h2>
            <div class="log" id="log">Keyframe诊断工具准备就绪...\n</div>
        </div>
    </div>

    <script type="module">
        let testFile = null;
        let sampleData = [];

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#58a6ff',
                success: '#56d364',
                error: '#f85149',
                warning: '#e3b341'
            };
            
            const logEntry = `[${timestamp}] ${message}\n`;
            logEl.innerHTML += `<span style="color: ${colors[type]}">${logEntry}</span>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStats(stats) {
            document.getElementById('totalFrames').textContent = stats.total;
            document.getElementById('keyFrames').textContent = stats.keyframes;
            document.getElementById('deltaFrames').textContent = stats.delta;
            document.getElementById('keyframeInterval').textContent = stats.interval;
        }

        function displayKeyframes(samples) {
            const listEl = document.getElementById('keyframeList');
            listEl.innerHTML = '';
            
            if (samples.length === 0) {
                listEl.innerHTML = '<div style="color: #656d76;">未发现样本数据</div>';
                return;
            }

            samples.slice(0, 50).forEach((sample, index) => {
                const item = document.createElement('div');
                item.className = `keyframe-item ${sample.isSync ? 'key' : 'delta'}`;
                item.innerHTML = `
                    <strong>${sample.isSync ? '🔑 KEY' : '📄 DELTA'}</strong> 
                    Sample #${index + 1} | 
                    Time: ${sample.timestamp.toFixed(3)}s | 
                    Size: ${sample.size} bytes | 
                    Duration: ${sample.duration.toFixed(3)}s
                `;
                listEl.appendChild(item);
            });

            if (samples.length > 50) {
                const moreItem = document.createElement('div');
                moreItem.style.color = '#656d76';
                moreItem.style.textAlign = 'center';
                moreItem.textContent = `... 还有 ${samples.length - 50} 个样本 (只显示前50个)`;
                listEl.appendChild(moreItem);
            }
        }

        window.clearLog = function() {
            document.getElementById('log').innerHTML = 'Keyframe诊断工具准备就绪...\n';
        };

        // 文件选择处理
        document.getElementById('videoFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                testFile = file;
                document.getElementById('analyzeBtn').disabled = false;
                log(`文件选择: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`, 'info');
            }
        });

        // 关键帧分析
        window.analyzeKeyframes = async function() {
            if (!testFile) {
                log('❌ 请先选择文件', 'error');
                return;
            }

            log('=== 开始关键帧分析 ===', 'info');
            sampleData = [];

            try {
                // 1. 导入MP4Parser
                log('📦 导入MP4Parser...', 'info');
                const { MP4Parser } = await import('./src/parser/mp4-parser.js');

                // 2. 创建解析器
                log('🏗️ 创建MP4解析器...', 'info');
                const parser = new MP4Parser();

                // 3. 设置回调
                parser.onReady = (info) => {
                    log('✅ MP4解析完成', 'success');
                    log(`📹 视频轨道: ${info.hasVideo ? '有' : '无'}`, 'info');
                    log(`🔊 音频轨道: ${info.hasAudio ? '有' : '无'}`, 'info');
                    log(`⏱️ 时长: ${(info.duration / info.timescale).toFixed(2)}秒`, 'info');
                    log(`📊 轨道数量: ${info.tracks.length}`, 'info');

                    // 开始样本提取
                    if (info.hasVideo && parser.videoTrack) {
                        log('🎬 开始提取视频样本...', 'info');
                        parser.mp4boxfile.setExtractionOptions(parser.videoTrack.id, null, {
                            nbSamples: 1000, // 提取更多样本用于分析
                            rapAlignement: true
                        });
                        parser.mp4boxfile.start();
                    } else {
                        log('⚠️ 未找到视频轨道', 'warning');
                    }
                };

                parser.onSamples = (trackId, samples) => {
                    log(`📦 收到样本: trackId=${trackId}, count=${samples.length}`, 'info');
                    
                    // 分析每个样本
                    for (let i = 0; i < samples.length; i++) {
                        const sample = samples[i];
                        const sampleInfo = parser.getSampleData(sample);
                        sampleData.push(sampleInfo);
                        
                        if (i < 10) { // 只记录前10个样本的详细信息
                            log(`  ${sampleInfo.isSync ? '🔑' : '📄'} Sample ${i+1}: ${sampleInfo.timestamp.toFixed(3)}s, ${sampleInfo.size}B, sync=${sampleInfo.isSync}`, 
                                sampleInfo.isSync ? 'success' : 'info');
                        }
                    }

                    // 更新统计信息
                    const stats = analyzeKeyframePattern(sampleData);
                    updateStats(stats);
                    displayKeyframes(sampleData);
                    
                    log(`📊 关键帧分析: ${stats.keyframes}/${stats.total} (${((stats.keyframes/stats.total)*100).toFixed(1)}%)`, 'success');
                };

                parser.onError = (error) => {
                    log(`❌ MP4解析错误: ${error}`, 'error');
                };

                // 4. 初始化并加载文件
                log('🔧 初始化解析器...', 'info');
                parser.init();

                log('📂 读取文件数据...', 'info');
                const arrayBuffer = await testFile.arrayBuffer();
                
                log(`📦 发送数据到解析器 (${arrayBuffer.byteLength} bytes)...`, 'info');
                await parser.appendBuffer(arrayBuffer);

            } catch (error) {
                log(`❌ 分析失败: ${error.message}`, 'error');
                console.error('关键帧分析详细错误:', error);
            }
        };

        function analyzeKeyframePattern(samples) {
            if (samples.length === 0) {
                return { total: 0, keyframes: 0, delta: 0, interval: 0 };
            }

            const keyframes = samples.filter(s => s.isSync);
            const deltaFrames = samples.filter(s => !s.isSync);
            
            // 计算关键帧间隔
            let totalInterval = 0;
            let intervalCount = 0;
            
            for (let i = 1; i < keyframes.length; i++) {
                const prevIndex = samples.findIndex(s => s === keyframes[i-1]);
                const currIndex = samples.findIndex(s => s === keyframes[i]);
                if (prevIndex !== -1 && currIndex !== -1) {
                    totalInterval += (currIndex - prevIndex);
                    intervalCount++;
                }
            }

            const avgInterval = intervalCount > 0 ? Math.round(totalInterval / intervalCount) : 0;

            return {
                total: samples.length,
                keyframes: keyframes.length,
                delta: deltaFrames.length,
                interval: avgInterval
            };
        }

        // 全局错误处理
        window.addEventListener('error', function(e) {
            log(`💥 全局错误: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            log(`💥 未处理的Promise错误: ${e.reason}`, 'error');
        });

        log('🚀 Keyframe诊断工具加载完成', 'success');
    </script>
</body>
</html>