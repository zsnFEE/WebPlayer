<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”‘ Keyframe è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .section {
            background: #161b22;
            border: 1px solid #30363d;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
        }
        h2 {
            color: #58a6ff;
            margin-top: 0;
        }
        button {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #2ea043; }
        button:disabled { background: #484f58; cursor: not-allowed; }
        input[type="file"] {
            margin: 10px 0;
            padding: 8px;
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            border-radius: 6px;
            width: 100%;
        }
        .log {
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 15px;
            border-radius: 6px;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }
        .keyframe-list {
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 15px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }
        .keyframe-item {
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .keyframe-item.key {
            background: #0f2419;
            border-left-color: #238636;
        }
        .keyframe-item.delta {
            background: #1c2128;
            border-left-color: #656d76;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .stat-box {
            background: #21262d;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #58a6ff;
        }
        .error { color: #f85149; }
        .success { color: #56d364; }
        .warning { color: #e3b341; }
        .info { color: #58a6ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”‘ Keyframe è¯Šæ–­å·¥å…·</h1>
        <p>ä¸“é—¨åˆ†æMP4æ–‡ä»¶çš„å…³é”®å¸§é—®é¢˜</p>

        <div class="section">
            <h2>ğŸ“ æ–‡ä»¶é€‰æ‹©</h2>
            <input type="file" id="videoFile" accept="video/*">
            <button onclick="analyzeKeyframes()" id="analyzeBtn" disabled>ğŸ” åˆ†æå…³é”®å¸§</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
        </div>

        <div class="section">
            <h2>ğŸ“Š å…³é”®å¸§ç»Ÿè®¡</h2>
            <div class="stats" id="stats">
                <div class="stat-box">
                    <div class="stat-value" id="totalFrames">0</div>
                    <div>æ€»å¸§æ•°</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="keyFrames">0</div>
                    <div>å…³é”®å¸§</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="deltaFrames">0</div>
                    <div>Deltaå¸§</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="keyframeInterval">0</div>
                    <div>å…³é”®å¸§é—´éš”</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ¬ å…³é”®å¸§åˆ—è¡¨</h2>
            <div class="keyframe-list" id="keyframeList">
                ç­‰å¾…åˆ†æ...
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
            <div class="log" id="log">Keyframeè¯Šæ–­å·¥å…·å‡†å¤‡å°±ç»ª...\n</div>
        </div>
    </div>

    <script type="module">
        let testFile = null;
        let sampleData = [];

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#58a6ff',
                success: '#56d364',
                error: '#f85149',
                warning: '#e3b341'
            };
            
            const logEntry = `[${timestamp}] ${message}\n`;
            logEl.innerHTML += `<span style="color: ${colors[type]}">${logEntry}</span>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStats(stats) {
            document.getElementById('totalFrames').textContent = stats.total;
            document.getElementById('keyFrames').textContent = stats.keyframes;
            document.getElementById('deltaFrames').textContent = stats.delta;
            document.getElementById('keyframeInterval').textContent = stats.interval;
        }

        function displayKeyframes(samples) {
            const listEl = document.getElementById('keyframeList');
            listEl.innerHTML = '';
            
            if (samples.length === 0) {
                listEl.innerHTML = '<div style="color: #656d76;">æœªå‘ç°æ ·æœ¬æ•°æ®</div>';
                return;
            }

            samples.slice(0, 50).forEach((sample, index) => {
                const item = document.createElement('div');
                item.className = `keyframe-item ${sample.isSync ? 'key' : 'delta'}`;
                item.innerHTML = `
                    <strong>${sample.isSync ? 'ğŸ”‘ KEY' : 'ğŸ“„ DELTA'}</strong> 
                    Sample #${index + 1} | 
                    Time: ${sample.timestamp.toFixed(3)}s | 
                    Size: ${sample.size} bytes | 
                    Duration: ${sample.duration.toFixed(3)}s
                `;
                listEl.appendChild(item);
            });

            if (samples.length > 50) {
                const moreItem = document.createElement('div');
                moreItem.style.color = '#656d76';
                moreItem.style.textAlign = 'center';
                moreItem.textContent = `... è¿˜æœ‰ ${samples.length - 50} ä¸ªæ ·æœ¬ (åªæ˜¾ç¤ºå‰50ä¸ª)`;
                listEl.appendChild(moreItem);
            }
        }

        window.clearLog = function() {
            document.getElementById('log').innerHTML = 'Keyframeè¯Šæ–­å·¥å…·å‡†å¤‡å°±ç»ª...\n';
        };

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        document.getElementById('videoFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                testFile = file;
                document.getElementById('analyzeBtn').disabled = false;
                log(`æ–‡ä»¶é€‰æ‹©: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`, 'info');
            }
        });

        // å…³é”®å¸§åˆ†æ
        window.analyzeKeyframes = async function() {
            if (!testFile) {
                log('âŒ è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            log('=== å¼€å§‹å…³é”®å¸§åˆ†æ ===', 'info');
            sampleData = [];

            try {
                // 1. å¯¼å…¥MP4Parser
                log('ğŸ“¦ å¯¼å…¥MP4Parser...', 'info');
                const { MP4Parser } = await import('./src/parser/mp4-parser.js');

                // 2. åˆ›å»ºè§£æå™¨
                log('ğŸ—ï¸ åˆ›å»ºMP4è§£æå™¨...', 'info');
                const parser = new MP4Parser();

                // 3. è®¾ç½®å›è°ƒ
                parser.onReady = (info) => {
                    log('âœ… MP4è§£æå®Œæˆ', 'success');
                    log(`ğŸ“¹ è§†é¢‘è½¨é“: ${info.hasVideo ? 'æœ‰' : 'æ— '}`, 'info');
                    log(`ğŸ”Š éŸ³é¢‘è½¨é“: ${info.hasAudio ? 'æœ‰' : 'æ— '}`, 'info');
                    log(`â±ï¸ æ—¶é•¿: ${(info.duration / info.timescale).toFixed(2)}ç§’`, 'info');
                    log(`ğŸ“Š è½¨é“æ•°é‡: ${info.tracks.length}`, 'info');

                    // å¼€å§‹æ ·æœ¬æå–
                    if (info.hasVideo && parser.videoTrack) {
                        log('ğŸ¬ å¼€å§‹æå–è§†é¢‘æ ·æœ¬...', 'info');
                        parser.mp4boxfile.setExtractionOptions(parser.videoTrack.id, null, {
                            nbSamples: 1000, // æå–æ›´å¤šæ ·æœ¬ç”¨äºåˆ†æ
                            rapAlignement: true
                        });
                        parser.mp4boxfile.start();
                    } else {
                        log('âš ï¸ æœªæ‰¾åˆ°è§†é¢‘è½¨é“', 'warning');
                    }
                };

                parser.onSamples = (trackId, samples) => {
                    log(`ğŸ“¦ æ”¶åˆ°æ ·æœ¬: trackId=${trackId}, count=${samples.length}`, 'info');
                    
                    // åˆ†ææ¯ä¸ªæ ·æœ¬
                    for (let i = 0; i < samples.length; i++) {
                        const sample = samples[i];
                        const sampleInfo = parser.getSampleData(sample);
                        sampleData.push(sampleInfo);
                        
                        if (i < 10) { // åªè®°å½•å‰10ä¸ªæ ·æœ¬çš„è¯¦ç»†ä¿¡æ¯
                            log(`  ${sampleInfo.isSync ? 'ğŸ”‘' : 'ğŸ“„'} Sample ${i+1}: ${sampleInfo.timestamp.toFixed(3)}s, ${sampleInfo.size}B, sync=${sampleInfo.isSync}`, 
                                sampleInfo.isSync ? 'success' : 'info');
                        }
                    }

                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    const stats = analyzeKeyframePattern(sampleData);
                    updateStats(stats);
                    displayKeyframes(sampleData);
                    
                    log(`ğŸ“Š å…³é”®å¸§åˆ†æ: ${stats.keyframes}/${stats.total} (${((stats.keyframes/stats.total)*100).toFixed(1)}%)`, 'success');
                };

                parser.onError = (error) => {
                    log(`âŒ MP4è§£æé”™è¯¯: ${error}`, 'error');
                };

                // 4. åˆå§‹åŒ–å¹¶åŠ è½½æ–‡ä»¶
                log('ğŸ”§ åˆå§‹åŒ–è§£æå™¨...', 'info');
                parser.init();

                log('ğŸ“‚ è¯»å–æ–‡ä»¶æ•°æ®...', 'info');
                const arrayBuffer = await testFile.arrayBuffer();
                
                log(`ğŸ“¦ å‘é€æ•°æ®åˆ°è§£æå™¨ (${arrayBuffer.byteLength} bytes)...`, 'info');
                await parser.appendBuffer(arrayBuffer);

            } catch (error) {
                log(`âŒ åˆ†æå¤±è´¥: ${error.message}`, 'error');
                console.error('å…³é”®å¸§åˆ†æè¯¦ç»†é”™è¯¯:', error);
            }
        };

        function analyzeKeyframePattern(samples) {
            if (samples.length === 0) {
                return { total: 0, keyframes: 0, delta: 0, interval: 0 };
            }

            const keyframes = samples.filter(s => s.isSync);
            const deltaFrames = samples.filter(s => !s.isSync);
            
            // è®¡ç®—å…³é”®å¸§é—´éš”
            let totalInterval = 0;
            let intervalCount = 0;
            
            for (let i = 1; i < keyframes.length; i++) {
                const prevIndex = samples.findIndex(s => s === keyframes[i-1]);
                const currIndex = samples.findIndex(s => s === keyframes[i]);
                if (prevIndex !== -1 && currIndex !== -1) {
                    totalInterval += (currIndex - prevIndex);
                    intervalCount++;
                }
            }

            const avgInterval = intervalCount > 0 ? Math.round(totalInterval / intervalCount) : 0;

            return {
                total: samples.length,
                keyframes: keyframes.length,
                delta: deltaFrames.length,
                interval: avgInterval
            };
        }

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            log(`ğŸ’¥ å…¨å±€é”™è¯¯: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            log(`ğŸ’¥ æœªå¤„ç†çš„Promiseé”™è¯¯: ${e.reason}`, 'error');
        });

        log('ğŸš€ Keyframeè¯Šæ–­å·¥å…·åŠ è½½å®Œæˆ', 'success');
    </script>
</body>
</html>