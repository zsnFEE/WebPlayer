<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ FFmpegè§£ç å™¨ä¸“ç”¨æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border: 1px solid #666;
            color: white;
            border-radius: 5px;
            width: 100%;
        }
        canvas {
            border: 2px solid #444;
            border-radius: 5px;
            background: #000;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px;
            display: inline-block;
            font-size: 12px;
        }
        .status.success { background: #4CAF50; }
        .status.error { background: #f44336; }
        .status.warning { background: #ff9800; }
        .status.info { background: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ FFmpegè§£ç å™¨ä¸“ç”¨æµ‹è¯•</h1>
        <p>ä¸“é—¨æµ‹è¯•FFmpeg.wasmè§£ç å™¨ï¼Œç»•è¿‡WebCodecsçš„keyframeé—®é¢˜</p>

        <div class="section">
            <h3>ğŸ“ æ–‡ä»¶é€‰æ‹©</h3>
            <input type="file" id="videoFile" accept="video/*">
            <button onclick="startFFmpegTest()" id="testBtn" disabled>ğŸš€ å¼€å§‹FFmpegæµ‹è¯•</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
        </div>

        <div class="section">
            <h3>ğŸ¥ æ’­æ”¾åŒºåŸŸ</h3>
            <canvas id="playerCanvas" width="800" height="450"></canvas>
        </div>

        <div class="section">
            <h3>ğŸ“Š æµ‹è¯•çŠ¶æ€</h3>
            <div id="status">
                <span class="status info">ç­‰å¾…æ–‡ä»¶é€‰æ‹©...</span>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ“ è¯¦ç»†æ—¥å¿—</h3>
            <div id="log" class="log">FFmpegæµ‹è¯•å‡†å¤‡å°±ç»ª...\n</div>
        </div>
    </div>

    <script type="module">
        let player = null;
        let testFile = null;

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            logEl.textContent += logEntry;
            logEl.scrollTop = logEl.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `<span class="status ${type}">${message}</span>`;
        }

        window.clearLog = function() {
            document.getElementById('log').textContent = 'FFmpegæµ‹è¯•å‡†å¤‡å°±ç»ª...\n';
        };

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        document.getElementById('videoFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                testFile = file;
                document.getElementById('testBtn').disabled = false;
                updateStatus(`æ–‡ä»¶å·²é€‰æ‹©: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`, 'success');
                log(`æ–‡ä»¶é€‰æ‹©: ${file.name}, å¤§å°: ${(file.size/1024/1024).toFixed(2)}MB, ç±»å‹: ${file.type}`);
            }
        });

        // FFmpegä¸“ç”¨æµ‹è¯•
        window.startFFmpegTest = async function() {
            if (!testFile) {
                log('âŒ è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            updateStatus('æ­£åœ¨è¿›è¡ŒFFmpegæµ‹è¯•...', 'warning');
            log('=== å¼€å§‹FFmpegè§£ç å™¨ä¸“ç”¨æµ‹è¯• ===');

            try {
                // 1. å¯¼å…¥æ’­æ”¾å™¨ç±»
                log('ğŸ“¦ å¯¼å…¥æ’­æ”¾å™¨æ¨¡å—...');
                const module = await import('./main.js');
                const { WebAVPlayer } = module;

                // 2. åˆ›å»ºæ’­æ”¾å™¨å®ä¾‹
                log('ğŸ—ï¸ åˆ›å»ºæ’­æ”¾å™¨å®ä¾‹...');
                const canvas = document.getElementById('playerCanvas');
                player = new WebAVPlayer(canvas);

                // 3. è®¾ç½®å›è°ƒ
                player.onMediaReady = () => {
                    log('âœ… åª’ä½“å‡†å¤‡å°±ç»ªï¼');
                    updateStatus('åª’ä½“è§£ææˆåŠŸ', 'success');
                };

                player.onError = (error) => {
                    log(`âŒ æ’­æ”¾å™¨é”™è¯¯: ${error}`, 'error');
                    updateStatus('æ’­æ”¾å™¨é”™è¯¯', 'error');
                };

                player.onTimeUpdate = (time) => {
                    log(`â° æ’­æ”¾æ—¶é—´: ${time.toFixed(2)}s`);
                };

                // 4. åˆå§‹åŒ–æ’­æ”¾å™¨ (åº”è¯¥ä½¿ç”¨FFmpeg)
                log('ğŸ”§ åˆå§‹åŒ–æ’­æ”¾å™¨...');
                await player.initialize();
                
                // æ£€æŸ¥ä½¿ç”¨çš„è§£ç å™¨ç±»å‹
                const decoderType = player.decoder?.constructor?.name || 'Unknown';
                log(`ğŸ¯ ä½¿ç”¨çš„è§£ç å™¨: ${decoderType}`);
                
                if (decoderType === 'FFmpegDecoder') {
                    log('âœ… æˆåŠŸä½¿ç”¨FFmpegè§£ç å™¨');
                    updateStatus('FFmpegè§£ç å™¨å·²å°±ç»ª', 'success');
                } else {
                    log(`âš ï¸ ä½¿ç”¨çš„ä¸æ˜¯FFmpegè§£ç å™¨: ${decoderType}`, 'warning');
                    updateStatus(`æ„å¤–çš„è§£ç å™¨: ${decoderType}`, 'warning');
                }

                // 5. åŠ è½½æ–‡ä»¶
                log('ğŸ“‚ åŠ è½½è§†é¢‘æ–‡ä»¶...');
                await player.loadFile(testFile);
                log('âœ… æ–‡ä»¶åŠ è½½å®Œæˆ');

                // 6. ç­‰å¾…è§£æå®Œæˆ
                log('â³ ç­‰å¾…åª’ä½“ä¿¡æ¯è§£æ...');
                let attempts = 0;
                const maxAttempts = 20;
                
                const checkMediaInfo = () => {
                    attempts++;
                    const state = player.getState();
                    
                    if (state.mediaInfo) {
                        log('âœ… åª’ä½“ä¿¡æ¯è§£ææˆåŠŸ');
                        log(`ğŸ“¹ è§†é¢‘: ${state.mediaInfo.hasVideo ? 'æœ‰' : 'æ— '}`);
                        log(`ğŸ”Š éŸ³é¢‘: ${state.mediaInfo.hasAudio ? 'æœ‰' : 'æ— '}`);
                        log(`â±ï¸ æ—¶é•¿: ${state.duration.toFixed(2)}ç§’`);
                        
                        updateStatus('å‡†å¤‡æ’­æ”¾', 'success');
                        
                        // 7. å°è¯•æ’­æ”¾
                        log('â–¶ï¸ å¼€å§‹æ’­æ”¾...');
                        player.play().then(() => {
                            log('âœ… æ’­æ”¾å‘½ä»¤æ‰§è¡ŒæˆåŠŸ');
                            updateStatus('æ­£åœ¨æ’­æ”¾', 'success');
                            
                            // ç›‘æ§æ’­æ”¾çŠ¶æ€
                            setTimeout(() => {
                                const newState = player.getState();
                                if (newState.playing) {
                                    log('ğŸ‰ æ’­æ”¾çŠ¶æ€ç¡®è®¤: æ­£åœ¨æ’­æ”¾');
                                    updateStatus('æ’­æ”¾æˆåŠŸï¼', 'success');
                                } else {
                                    log('âš ï¸ æ’­æ”¾çŠ¶æ€å¼‚å¸¸: æœªåœ¨æ’­æ”¾', 'warning');
                                    updateStatus('æ’­æ”¾çŠ¶æ€å¼‚å¸¸', 'warning');
                                }
                            }, 2000);
                        }).catch(error => {
                            log(`âŒ æ’­æ”¾å¤±è´¥: ${error}`, 'error');
                            updateStatus('æ’­æ”¾å¤±è´¥', 'error');
                        });
                        
                        return;
                    }
                    
                    if (attempts < maxAttempts) {
                        log(`â³ ç­‰å¾…åª’ä½“ä¿¡æ¯... (${attempts}/${maxAttempts})`);
                        setTimeout(checkMediaInfo, 500);
                    } else {
                        log('âŒ åª’ä½“ä¿¡æ¯è§£æè¶…æ—¶', 'error');
                        updateStatus('è§£æè¶…æ—¶', 'error');
                    }
                };
                
                checkMediaInfo();

            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus('æµ‹è¯•å¤±è´¥', 'error');
                console.error('FFmpegæµ‹è¯•è¯¦ç»†é”™è¯¯:', error);
            }
        };

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            log(`ğŸ’¥ å…¨å±€é”™è¯¯: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            log(`ğŸ’¥ æœªå¤„ç†çš„Promiseé”™è¯¯: ${e.reason}`, 'error');
        });

        log('ğŸš€ FFmpegæµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
        updateStatus('ç­‰å¾…æ–‡ä»¶é€‰æ‹©...', 'info');
    </script>
</body>
</html>