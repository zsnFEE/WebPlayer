<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎬 FFmpeg解码器专用测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border: 1px solid #666;
            color: white;
            border-radius: 5px;
            width: 100%;
        }
        canvas {
            border: 2px solid #444;
            border-radius: 5px;
            background: #000;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px;
            display: inline-block;
            font-size: 12px;
        }
        .status.success { background: #4CAF50; }
        .status.error { background: #f44336; }
        .status.warning { background: #ff9800; }
        .status.info { background: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎬 FFmpeg解码器专用测试</h1>
        <p>专门测试FFmpeg.wasm解码器，绕过WebCodecs的keyframe问题</p>

        <div class="section">
            <h3>📁 文件选择</h3>
            <input type="file" id="videoFile" accept="video/*">
            <button onclick="startFFmpegTest()" id="testBtn" disabled>🚀 开始FFmpeg测试</button>
            <button onclick="clearLog()">🗑️ 清除日志</button>
        </div>

        <div class="section">
            <h3>🎥 播放区域</h3>
            <canvas id="playerCanvas" width="800" height="450"></canvas>
        </div>

        <div class="section">
            <h3>📊 测试状态</h3>
            <div id="status">
                <span class="status info">等待文件选择...</span>
            </div>
        </div>

        <div class="section">
            <h3>📝 详细日志</h3>
            <div id="log" class="log">FFmpeg测试准备就绪...\n</div>
        </div>
    </div>

    <script type="module">
        let player = null;
        let testFile = null;

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            logEl.textContent += logEntry;
            logEl.scrollTop = logEl.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `<span class="status ${type}">${message}</span>`;
        }

        window.clearLog = function() {
            document.getElementById('log').textContent = 'FFmpeg测试准备就绪...\n';
        };

        // 文件选择处理
        document.getElementById('videoFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                testFile = file;
                document.getElementById('testBtn').disabled = false;
                updateStatus(`文件已选择: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`, 'success');
                log(`文件选择: ${file.name}, 大小: ${(file.size/1024/1024).toFixed(2)}MB, 类型: ${file.type}`);
            }
        });

        // FFmpeg专用测试
        window.startFFmpegTest = async function() {
            if (!testFile) {
                log('❌ 请先选择文件', 'error');
                return;
            }

            updateStatus('正在进行FFmpeg测试...', 'warning');
            log('=== 开始FFmpeg解码器专用测试 ===');

            try {
                // 1. 导入播放器类
                log('📦 导入播放器模块...');
                const module = await import('./main.js');
                const { WebAVPlayer } = module;

                // 2. 创建播放器实例
                log('🏗️ 创建播放器实例...');
                const canvas = document.getElementById('playerCanvas');
                player = new WebAVPlayer(canvas);

                // 3. 设置回调
                player.onMediaReady = () => {
                    log('✅ 媒体准备就绪！');
                    updateStatus('媒体解析成功', 'success');
                };

                player.onError = (error) => {
                    log(`❌ 播放器错误: ${error}`, 'error');
                    updateStatus('播放器错误', 'error');
                };

                player.onTimeUpdate = (time) => {
                    log(`⏰ 播放时间: ${time.toFixed(2)}s`);
                };

                // 4. 初始化播放器 (应该使用FFmpeg)
                log('🔧 初始化播放器...');
                await player.initialize();
                
                // 检查使用的解码器类型
                const decoderType = player.decoder?.constructor?.name || 'Unknown';
                log(`🎯 使用的解码器: ${decoderType}`);
                
                if (decoderType === 'FFmpegDecoder') {
                    log('✅ 成功使用FFmpeg解码器');
                    updateStatus('FFmpeg解码器已就绪', 'success');
                } else {
                    log(`⚠️ 使用的不是FFmpeg解码器: ${decoderType}`, 'warning');
                    updateStatus(`意外的解码器: ${decoderType}`, 'warning');
                }

                // 5. 加载文件
                log('📂 加载视频文件...');
                await player.loadFile(testFile);
                log('✅ 文件加载完成');

                // 6. 等待解析完成
                log('⏳ 等待媒体信息解析...');
                let attempts = 0;
                const maxAttempts = 20;
                
                const checkMediaInfo = () => {
                    attempts++;
                    const state = player.getState();
                    
                    if (state.mediaInfo) {
                        log('✅ 媒体信息解析成功');
                        log(`📹 视频: ${state.mediaInfo.hasVideo ? '有' : '无'}`);
                        log(`🔊 音频: ${state.mediaInfo.hasAudio ? '有' : '无'}`);
                        log(`⏱️ 时长: ${state.duration.toFixed(2)}秒`);
                        
                        updateStatus('准备播放', 'success');
                        
                        // 7. 尝试播放
                        log('▶️ 开始播放...');
                        player.play().then(() => {
                            log('✅ 播放命令执行成功');
                            updateStatus('正在播放', 'success');
                            
                            // 监控播放状态
                            setTimeout(() => {
                                const newState = player.getState();
                                if (newState.playing) {
                                    log('🎉 播放状态确认: 正在播放');
                                    updateStatus('播放成功！', 'success');
                                } else {
                                    log('⚠️ 播放状态异常: 未在播放', 'warning');
                                    updateStatus('播放状态异常', 'warning');
                                }
                            }, 2000);
                        }).catch(error => {
                            log(`❌ 播放失败: ${error}`, 'error');
                            updateStatus('播放失败', 'error');
                        });
                        
                        return;
                    }
                    
                    if (attempts < maxAttempts) {
                        log(`⏳ 等待媒体信息... (${attempts}/${maxAttempts})`);
                        setTimeout(checkMediaInfo, 500);
                    } else {
                        log('❌ 媒体信息解析超时', 'error');
                        updateStatus('解析超时', 'error');
                    }
                };
                
                checkMediaInfo();

            } catch (error) {
                log(`❌ 测试失败: ${error.message}`, 'error');
                updateStatus('测试失败', 'error');
                console.error('FFmpeg测试详细错误:', error);
            }
        };

        // 全局错误处理
        window.addEventListener('error', function(e) {
            log(`💥 全局错误: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            log(`💥 未处理的Promise错误: ${e.reason}`, 'error');
        });

        log('🚀 FFmpeg测试页面加载完成');
        updateStatus('等待文件选择...', 'info');
    </script>
</body>
</html>