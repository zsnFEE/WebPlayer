<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple WebAV Player</title>
    
    <!-- 内联polyfills避免模块加载问题 -->
    <script>
        console.log('🔧 Loading inline polyfills...');
        
        // 修复global
        if (!window.global) {
            window.global = window;
        }
        
        // 修复crypto
        if (!window.crypto) {
            window.crypto = {};
        }
        
        if (!window.crypto.getRandomValues) {
            window.crypto.getRandomValues = function(array) {
                for (let i = 0; i < array.length; i++) {
                    array[i] = Math.floor(Math.random() * 256);
                }
                return array;
            };
        }
        
        // 修复process
        if (!window.process) {
            window.process = {
                env: {},
                browser: true,
                nextTick: function(fn) { setTimeout(fn, 0); }
            };
        }
        
        // SharedArrayBuffer后备
        if (typeof SharedArrayBuffer === 'undefined') {
            window.SharedArrayBuffer = ArrayBuffer;
        }
        
        console.log('✅ Inline polyfills loaded');
        
        // 错误捕获
        window.addEventListener('error', (e) => {
            console.error('❌ Global Error:', e.message, 'at', e.filename + ':' + e.lineno);
            const errorDiv = document.getElementById('errors');
            if (errorDiv) {
                errorDiv.innerHTML += `<div style="color: red; margin: 10px 0; padding: 10px; background: #ffe6e6; border: 1px solid red;">
                    ERROR: ${e.message}<br>
                    File: ${e.filename}<br>
                    Line: ${e.lineno}
                </div>`;
            }
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('❌ Promise Rejection:', e.reason);
            const errorDiv = document.getElementById('errors');
            if (errorDiv) {
                errorDiv.innerHTML += `<div style="color: red; margin: 10px 0; padding: 10px; background: #ffe6e6; border: 1px solid red;">
                    PROMISE REJECTION: ${e.reason}
                </div>`;
            }
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #video-canvas {
            width: 100%;
            max-width: 800px;
            height: 450px;
            background: #000;
            border: 1px solid #ccc;
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .primary { background: #007bff; color: white; }
        .success { background: #28a745; color: white; }
        .danger { background: #dc3545; color: white; }
        
        #status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .status-info { background: #d1ecf1; color: #0c5460; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        
        #errors {
            margin-top: 20px;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎬 Simple WebAV Player Test</h1>
        <p>Node.js Version: <strong>v22.16.0</strong> | 简化调试版本</p>
        
        <div id="status" class="status-info">等待初始化...</div>
        
        <canvas id="video-canvas"></canvas>
        
        <div class="controls">
            <button class="primary" onclick="testBasics()">测试基础功能</button>
            <button class="success" onclick="testModules()">测试模块加载</button>
            <button class="danger" onclick="clearErrors()">清除错误</button>
        </div>
        
        <div id="errors"></div>
    </div>
    
    <script>
        const statusEl = document.getElementById('status');
        const errorsEl = document.getElementById('errors');
        
        function updateStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.className = `status-${type}`;
        }
        
        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.style.cssText = `margin: 5px 0; padding: 10px; border-radius: 4px; ${
                type === 'error' ? 'background: #f8d7da; color: #721c24;' :
                type === 'success' ? 'background: #d4edda; color: #155724;' :
                'background: #d1ecf1; color: #0c5460;'
            }`;
            div.innerHTML = message;
            errorsEl.appendChild(div);
        }
        
        function clearErrors() {
            errorsEl.innerHTML = '';
        }
        
        function testBasics() {
            addLog('=== 基础功能测试 ===');
            addLog(`✓ crypto: ${typeof crypto !== 'undefined' ? 'YES' : 'NO'}`);
            addLog(`✓ crypto.getRandomValues: ${typeof crypto?.getRandomValues === 'function' ? 'YES' : 'NO'}`);
            addLog(`✓ global: ${typeof global !== 'undefined' ? 'YES' : 'NO'}`);
            addLog(`✓ process: ${typeof process !== 'undefined' ? 'YES' : 'NO'}`);
            addLog(`✓ WebAssembly: ${typeof WebAssembly !== 'undefined' ? 'YES' : 'NO'}`);
            addLog(`✓ SharedArrayBuffer: ${typeof SharedArrayBuffer !== 'undefined' ? 'YES' : 'NO'}`);
            
            // 测试crypto
            try {
                const testArray = new Uint8Array(4);
                crypto.getRandomValues(testArray);
                addLog(`✓ crypto.getRandomValues 工作正常: [${Array.from(testArray)}]`, 'success');
            } catch (e) {
                addLog(`❌ crypto.getRandomValues 失败: ${e.message}`, 'error');
            }
        }
        
        async function testModules() {
            addLog('=== 模块加载测试 ===');
            updateStatus('正在加载模块...', 'info');
            
            try {
                // 测试简单polyfills
                await import('/src/utils/simple-polyfills.js');
                addLog('✓ simple-polyfills.js 加载成功', 'success');
                
                // 测试播放器模块
                const playerModule = await import('/src/player.js');
                addLog('✓ player.js 加载成功', 'success');
                addLog(`✓ WebAVPlayer: ${typeof playerModule.WebAVPlayer === 'function' ? 'YES' : 'NO'}`);
                
                // 尝试创建实例
                const canvas = document.getElementById('video-canvas');
                if (canvas) {
                    const player = new playerModule.WebAVPlayer(canvas);
                    addLog('✅ WebAVPlayer 实例创建成功!', 'success');
                    updateStatus('播放器初始化成功!', 'success');
                } else {
                    addLog('❌ Canvas未找到', 'error');
                }
                
            } catch (error) {
                addLog(`❌ 模块加载失败: ${error.message}`, 'error');
                addLog(`Stack: ${error.stack}`, 'error');
                updateStatus('模块加载失败', 'error');
            }
        }
        
        // 页面加载完成后自动测试
        window.addEventListener('load', () => {
            updateStatus('页面加载完成', 'success');
            testBasics();
        });
    </script>
    
    <!-- 可选：加载简化版main.js -->
    <!-- <script type="module" src="/src/main-simple.js"></script> -->
</body>
</html>