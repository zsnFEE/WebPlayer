<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple WebAV Player</title>
    
    <!-- å†…è”polyfillsé¿å…æ¨¡å—åŠ è½½é—®é¢˜ -->
    <script>
        console.log('ğŸ”§ Loading inline polyfills...');
        
        // ä¿®å¤global
        if (!window.global) {
            window.global = window;
        }
        
        // ä¿®å¤crypto
        if (!window.crypto) {
            window.crypto = {};
        }
        
        if (!window.crypto.getRandomValues) {
            window.crypto.getRandomValues = function(array) {
                for (let i = 0; i < array.length; i++) {
                    array[i] = Math.floor(Math.random() * 256);
                }
                return array;
            };
        }
        
        // ä¿®å¤process
        if (!window.process) {
            window.process = {
                env: {},
                browser: true,
                nextTick: function(fn) { setTimeout(fn, 0); }
            };
        }
        
        // SharedArrayBufferåå¤‡
        if (typeof SharedArrayBuffer === 'undefined') {
            window.SharedArrayBuffer = ArrayBuffer;
        }
        
        console.log('âœ… Inline polyfills loaded');
        
        // é”™è¯¯æ•è·
        window.addEventListener('error', (e) => {
            console.error('âŒ Global Error:', e.message, 'at', e.filename + ':' + e.lineno);
            const errorDiv = document.getElementById('errors');
            if (errorDiv) {
                errorDiv.innerHTML += `<div style="color: red; margin: 10px 0; padding: 10px; background: #ffe6e6; border: 1px solid red;">
                    ERROR: ${e.message}<br>
                    File: ${e.filename}<br>
                    Line: ${e.lineno}
                </div>`;
            }
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('âŒ Promise Rejection:', e.reason);
            const errorDiv = document.getElementById('errors');
            if (errorDiv) {
                errorDiv.innerHTML += `<div style="color: red; margin: 10px 0; padding: 10px; background: #ffe6e6; border: 1px solid red;">
                    PROMISE REJECTION: ${e.reason}
                </div>`;
            }
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #video-canvas {
            width: 100%;
            max-width: 800px;
            height: 450px;
            background: #000;
            border: 1px solid #ccc;
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .primary { background: #007bff; color: white; }
        .success { background: #28a745; color: white; }
        .danger { background: #dc3545; color: white; }
        
        #status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .status-info { background: #d1ecf1; color: #0c5460; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        
        #errors {
            margin-top: 20px;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ Simple WebAV Player Test</h1>
        <p>Node.js Version: <strong>v22.16.0</strong> | ç®€åŒ–è°ƒè¯•ç‰ˆæœ¬</p>
        
        <div id="status" class="status-info">ç­‰å¾…åˆå§‹åŒ–...</div>
        
        <canvas id="video-canvas"></canvas>
        
        <div class="controls">
            <button class="primary" onclick="testBasics()">æµ‹è¯•åŸºç¡€åŠŸèƒ½</button>
            <button class="success" onclick="testModules()">æµ‹è¯•æ¨¡å—åŠ è½½</button>
            <button class="danger" onclick="clearErrors()">æ¸…é™¤é”™è¯¯</button>
        </div>
        
        <div id="errors"></div>
    </div>
    
    <script>
        const statusEl = document.getElementById('status');
        const errorsEl = document.getElementById('errors');
        
        function updateStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.className = `status-${type}`;
        }
        
        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.style.cssText = `margin: 5px 0; padding: 10px; border-radius: 4px; ${
                type === 'error' ? 'background: #f8d7da; color: #721c24;' :
                type === 'success' ? 'background: #d4edda; color: #155724;' :
                'background: #d1ecf1; color: #0c5460;'
            }`;
            div.innerHTML = message;
            errorsEl.appendChild(div);
        }
        
        function clearErrors() {
            errorsEl.innerHTML = '';
        }
        
        function testBasics() {
            addLog('=== åŸºç¡€åŠŸèƒ½æµ‹è¯• ===');
            addLog(`âœ“ crypto: ${typeof crypto !== 'undefined' ? 'YES' : 'NO'}`);
            addLog(`âœ“ crypto.getRandomValues: ${typeof crypto?.getRandomValues === 'function' ? 'YES' : 'NO'}`);
            addLog(`âœ“ global: ${typeof global !== 'undefined' ? 'YES' : 'NO'}`);
            addLog(`âœ“ process: ${typeof process !== 'undefined' ? 'YES' : 'NO'}`);
            addLog(`âœ“ WebAssembly: ${typeof WebAssembly !== 'undefined' ? 'YES' : 'NO'}`);
            addLog(`âœ“ SharedArrayBuffer: ${typeof SharedArrayBuffer !== 'undefined' ? 'YES' : 'NO'}`);
            
            // æµ‹è¯•crypto
            try {
                const testArray = new Uint8Array(4);
                crypto.getRandomValues(testArray);
                addLog(`âœ“ crypto.getRandomValues å·¥ä½œæ­£å¸¸: [${Array.from(testArray)}]`, 'success');
            } catch (e) {
                addLog(`âŒ crypto.getRandomValues å¤±è´¥: ${e.message}`, 'error');
            }
        }
        
        async function testModules() {
            addLog('=== æ¨¡å—åŠ è½½æµ‹è¯• ===');
            updateStatus('æ­£åœ¨åŠ è½½æ¨¡å—...', 'info');
            
            try {
                // æµ‹è¯•ç®€å•polyfills
                await import('/src/utils/simple-polyfills.js');
                addLog('âœ“ simple-polyfills.js åŠ è½½æˆåŠŸ', 'success');
                
                // æµ‹è¯•æ’­æ”¾å™¨æ¨¡å—
                const playerModule = await import('/src/player.js');
                addLog('âœ“ player.js åŠ è½½æˆåŠŸ', 'success');
                addLog(`âœ“ WebAVPlayer: ${typeof playerModule.WebAVPlayer === 'function' ? 'YES' : 'NO'}`);
                
                // å°è¯•åˆ›å»ºå®ä¾‹
                const canvas = document.getElementById('video-canvas');
                if (canvas) {
                    const player = new playerModule.WebAVPlayer(canvas);
                    addLog('âœ… WebAVPlayer å®ä¾‹åˆ›å»ºæˆåŠŸ!', 'success');
                    updateStatus('æ’­æ”¾å™¨åˆå§‹åŒ–æˆåŠŸ!', 'success');
                } else {
                    addLog('âŒ Canvasæœªæ‰¾åˆ°', 'error');
                }
                
            } catch (error) {
                addLog(`âŒ æ¨¡å—åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                addLog(`Stack: ${error.stack}`, 'error');
                updateStatus('æ¨¡å—åŠ è½½å¤±è´¥', 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', () => {
            updateStatus('é¡µé¢åŠ è½½å®Œæˆ', 'success');
            testBasics();
        });
    </script>
    
    <!-- å¯é€‰ï¼šåŠ è½½ç®€åŒ–ç‰ˆmain.js -->
    <!-- <script type="module" src="/src/main-simple.js"></script> -->
</body>
</html>