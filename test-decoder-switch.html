<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¯è§£ç¡¬è§£æµ‹è¯• - WebAV Player</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #1a1a1a; 
            color: #fff; 
            padding: 20px; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .decoder-section { 
            background: #2a2a2a; 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        .decoder-controls { 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        .decoder-btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 8px; 
            font-size: 14px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }
        .auto-btn { background: #4CAF50; color: white; }
        .ffmpeg-btn { background: #2196F3; color: white; }
        .webcodecs-btn { background: #FF9800; color: white; }
        .decoder-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .decoder-btn.active { box-shadow: 0 0 0 2px #fff; }
        .status { 
            background: #333; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            border-left: 4px solid #4CAF50; 
        }
        .file-upload { 
            border: 2px dashed #555; 
            border-radius: 12px; 
            padding: 40px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }
        .file-upload:hover { border-color: #777; background: #252525; }
        .file-upload.dragover { border-color: #4CAF50; background: #1e3a1e; }
        .file-input { display: none; }
        .canvas-container { 
            background: #000; 
            border-radius: 12px; 
            margin: 20px 0; 
            overflow: hidden; 
            position: relative; 
        }
        #test-canvas { width: 100%; height: 400px; display: block; }
        .decoder-info { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-top: 20px; 
        }
        .info-card { 
            background: #333; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .info-title { font-size: 12px; color: #888; margin-bottom: 5px; }
        .info-value { font-size: 16px; font-weight: bold; }
        .logs { 
            background: #1e1e1e; 
            border-radius: 8px; 
            padding: 15px; 
            margin-top: 20px; 
            max-height: 200px; 
            overflow-y: auto; 
            font-family: 'Consolas', monospace; 
            font-size: 12px; 
        }
        .log-entry { margin-bottom: 5px; }
        .log-info { color: #58a6ff; }
        .log-success { color: #56d364; }
        .log-warning { color: #e3b341; }
        .log-error { color: #f85149; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ è½¯è§£ç¡¬è§£æµ‹è¯•</h1>
            <p>æµ‹è¯•FFmpegè½¯è§£å’ŒWebCodecsç¡¬è§£çš„åˆ‡æ¢åŠŸèƒ½</p>
        </div>

        <div class="decoder-section">
            <h3>è§£ç å™¨é€‰æ‹©</h3>
            <div class="decoder-controls">
                <button id="auto-btn" class="decoder-btn auto-btn active">ğŸ¤– è‡ªåŠ¨é€‰æ‹©</button>
                <button id="ffmpeg-btn" class="decoder-btn ffmpeg-btn">ğŸ–¥ï¸ è½¯è§£ (FFmpeg)</button>
                <button id="webcodecs-btn" class="decoder-btn webcodecs-btn">âš¡ ç¡¬è§£ (WebCodecs)</button>
            </div>
            
            <div id="status" class="status">
                <strong>çŠ¶æ€:</strong> <span id="status-text">å°±ç»ªï¼Œè¯·ä¸Šä¼ è§†é¢‘æ–‡ä»¶è¿›è¡Œæµ‹è¯•</span>
            </div>
        </div>

        <div class="decoder-section">
            <h3>è§†é¢‘ä¸Šä¼ </h3>
            <div class="file-upload" id="file-upload">
                <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ“</div>
                <div style="font-size: 1.2rem; margin-bottom: 5px;">ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°è¿™é‡Œ</div>
                <div style="color: #888;">æ”¯æŒ MP4, WebM, AVI ç­‰æ ¼å¼</div>
                <input type="file" id="file-input" class="file-input" accept="video/*">
            </div>
        </div>

        <div class="decoder-section">
            <h3>è§†é¢‘æ’­æ”¾</h3>
            <div class="canvas-container">
                <canvas id="test-canvas"></canvas>
            </div>
            
            <div class="decoder-info">
                <div class="info-card">
                    <div class="info-title">å½“å‰è§£ç å™¨</div>
                    <div class="info-value" id="current-decoder">æœªåˆå§‹åŒ–</div>
                </div>
                <div class="info-card">
                    <div class="info-title">è§†é¢‘ç¼–ç </div>
                    <div class="info-value" id="video-codec">-</div>
                </div>
                <div class="info-card">
                    <div class="info-title">éŸ³é¢‘ç¼–ç </div>
                    <div class="info-value" id="audio-codec">-</div>
                </div>
                <div class="info-card">
                    <div class="info-title">åˆ†è¾¨ç‡</div>
                    <div class="info-value" id="resolution">-</div>
                </div>
                <div class="info-card">
                    <div class="info-title">å¸§ç‡</div>
                    <div class="info-value" id="framerate">-</div>
                </div>
                <div class="info-card">
                    <div class="info-title">æ—¶é•¿</div>
                    <div class="info-value" id="duration">-</div>
                </div>
            </div>
        </div>

        <div class="decoder-section">
            <h3>æµ‹è¯•æ—¥å¿—</h3>
            <div id="logs" class="logs">
                <div class="log-entry log-info">ğŸ“ æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { WebAVPlayer } from './src/player.js';

        class DecoderTest {
            constructor() {
                this.player = null;
                this.currentDecoderType = 'auto';
                this.initializeElements();
                this.setupEventListeners();
                this.setupPlayer();
            }

            initializeElements() {
                this.canvas = document.getElementById('test-canvas');
                this.fileInput = document.getElementById('file-input');
                this.fileUpload = document.getElementById('file-upload');
                this.statusText = document.getElementById('status-text');
                this.logs = document.getElementById('logs');
                
                this.autoBtn = document.getElementById('auto-btn');
                this.ffmpegBtn = document.getElementById('ffmpeg-btn');
                this.webcodecsBtn = document.getElementById('webcodecs-btn');
                
                this.currentDecoderEl = document.getElementById('current-decoder');
                this.videoCodecEl = document.getElementById('video-codec');
                this.audioCodecEl = document.getElementById('audio-codec');
                this.resolutionEl = document.getElementById('resolution');
                this.framerateEl = document.getElementById('framerate');
                this.durationEl = document.getElementById('duration');
            }

            setupEventListeners() {
                // è§£ç å™¨æŒ‰é’®
                this.autoBtn.addEventListener('click', () => this.selectDecoder('auto'));
                this.ffmpegBtn.addEventListener('click', () => this.selectDecoder('ffmpeg'));
                this.webcodecsBtn.addEventListener('click', () => this.selectDecoder('webcodecs'));
                
                // æ–‡ä»¶ä¸Šä¼ 
                this.fileUpload.addEventListener('click', () => this.fileInput.click());
                this.fileInput.addEventListener('change', (e) => this.handleFile(e.target.files[0]));
                
                // æ‹–æ‹½ä¸Šä¼ 
                this.fileUpload.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.fileUpload.classList.add('dragover');
                });
                
                this.fileUpload.addEventListener('dragleave', () => {
                    this.fileUpload.classList.remove('dragover');
                });
                
                this.fileUpload.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.fileUpload.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFile(files[0]);
                    }
                });
            }

            async setupPlayer() {
                try {
                    this.log('æ­£åœ¨åˆå§‹åŒ–æ’­æ”¾å™¨...', 'info');
                    this.player = new WebAVPlayer(this.canvas);
                    await this.player.initialize();
                    
                    // è®¾ç½®å›è°ƒ
                    this.player.onMediaReady = () => {
                        this.log('åª’ä½“å·²å‡†å¤‡å°±ç»ª', 'success');
                        this.updateInfo();
                    };
                    
                    this.player.onError = (error) => {
                        this.log(`æ’­æ”¾å™¨é”™è¯¯: ${error.message}`, 'error');
                    };
                    
                    this.log('æ’­æ”¾å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                    this.updateStatus('æ’­æ”¾å™¨å·²å°±ç»ªï¼Œè¯·é€‰æ‹©è§£ç å™¨å¹¶ä¸Šä¼ è§†é¢‘');
                    this.updateCurrentDecoder();
                    
                } catch (error) {
                    this.log(`æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                    this.updateStatus('æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥');
                }
            }

            async selectDecoder(type) {
                this.log(`é€‰æ‹©è§£ç å™¨: ${this.getDecoderName(type)}`, 'info');
                this.currentDecoderType = type;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.decoder-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`${type === 'webcodecs' ? 'webcodecs' : type}-btn`).classList.add('active');
                
                if (this.player) {
                    try {
                        this.updateStatus('æ­£åœ¨åˆ‡æ¢è§£ç å™¨...');
                        this.player.setDecoderPreference(type);
                        
                        // å¦‚æœæœ‰åª’ä½“ï¼Œé‡æ–°åˆå§‹åŒ–è§£ç å™¨
                        if (this.player.mediaInfo) {
                            await this.player.initDecoder(type);
                            this.log(`è§£ç å™¨åˆ‡æ¢æˆåŠŸ: ${this.getDecoderName(this.player.getCurrentDecoderType())}`, 'success');
                        }
                        
                        this.updateCurrentDecoder();
                        this.updateStatus('è§£ç å™¨åˆ‡æ¢å®Œæˆ');
                        
                    } catch (error) {
                        this.log(`è§£ç å™¨åˆ‡æ¢å¤±è´¥: ${error.message}`, 'error');
                        this.updateStatus('è§£ç å™¨åˆ‡æ¢å¤±è´¥');
                    }
                }
            }

            async handleFile(file) {
                if (!file) return;
                
                this.log(`å¼€å§‹åŠ è½½æ–‡ä»¶: ${file.name}`, 'info');
                this.updateStatus('æ­£åœ¨åŠ è½½è§†é¢‘æ–‡ä»¶...');
                
                try {
                    await this.player.loadFile(file);
                    this.log('æ–‡ä»¶åŠ è½½æˆåŠŸ', 'success');
                    
                } catch (error) {
                    this.log(`æ–‡ä»¶åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                    this.updateStatus('æ–‡ä»¶åŠ è½½å¤±è´¥');
                }
            }

            updateInfo() {
                if (!this.player || !this.player.mediaInfo) return;
                
                const info = this.player.mediaInfo;
                
                this.videoCodecEl.textContent = info.videoTracks?.[0]?.codec || '-';
                this.audioCodecEl.textContent = info.audioTracks?.[0]?.codec || '-';
                this.resolutionEl.textContent = info.videoTracks?.[0] ? 
                    `${info.videoTracks[0].track_width}Ã—${info.videoTracks[0].track_height}` : '-';
                this.framerateEl.textContent = info.videoTracks?.[0] ? 
                    `${(info.videoTracks[0].timescale / info.videoTracks[0].sample_duration).toFixed(1)} fps` : '-';
                this.durationEl.textContent = info.duration ? 
                    `${(info.duration / 1000).toFixed(1)}s` : '-';
            }

            updateCurrentDecoder() {
                if (this.player) {
                    const current = this.player.getCurrentDecoderType();
                    this.currentDecoderEl.textContent = current ? this.getDecoderName(current) : 'æœªåˆå§‹åŒ–';
                }
            }

            getDecoderName(type) {
                const names = {
                    'auto': 'è‡ªåŠ¨é€‰æ‹©',
                    'ffmpeg': 'è½¯è§£ (FFmpeg)',
                    'webcodecs': 'ç¡¬è§£ (WebCodecs)'
                };
                return names[type] || type;
            }

            updateStatus(message) {
                this.statusText.textContent = message;
            }

            log(message, type = 'info') {
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                this.logs.appendChild(entry);
                this.logs.scrollTop = this.logs.scrollHeight;
                console.log(`[DecoderTest] ${message}`);
            }
        }

        // å¯åŠ¨æµ‹è¯•
        new DecoderTest();
    </script>
</body>
</html>