<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎬 完全修复的播放器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .player-container {
            background: rgba(0,0,0,0.7);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .upload-zone {
            border: 2px dashed #4CAF50;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: rgba(76, 175, 80, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }
        .upload-zone:hover {
            background: rgba(76, 175, 80, 0.2);
            transform: translateY(-2px);
        }
        .upload-zone.dragover {
            background: rgba(76, 175, 80, 0.3);
            border-color: #81C784;
        }
        input[type="file"] {
            display: none;
        }
        .video-display {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        canvas, video {
            width: 100%;
            max-width: 800px;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        .controls {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        .control-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }
        button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .mode-switch {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196F3;
            color: #81C784;
        }
        .mode-switch.active {
            background: #2196F3;
            color: white;
        }
        .status-panel {
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .log-panel {
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎬 完全修复的播放器</h1>
        <p>智能播放器 - 自动选择最佳播放方式</p>

        <!-- 文件上传区域 -->
        <div class="upload-zone" id="uploadZone">
            <h3>📁 上传视频文件</h3>
            <p>拖拽文件到这里或点击选择</p>
            <input type="file" id="fileInput" accept="video/*">
        </div>

        <!-- 播放模式选择 -->
        <div class="player-container">
            <h3>🎯 播放模式</h3>
            <div class="control-row">
                <button class="mode-switch" id="autoModeBtn" onclick="setMode('auto')">🤖 智能模式</button>
                <button class="mode-switch" id="customModeBtn" onclick="setMode('custom')">⚙️ 自定义解码</button>
                <button class="mode-switch" id="nativeModeBtn" onclick="setMode('native')">🏠 原生播放</button>
            </div>
            <p id="modeDescription">智能模式：自动选择最佳播放方式</p>
        </div>

        <!-- 视频显示区域 -->
        <div class="video-display" id="videoDisplay">
            <canvas id="customCanvas" width="800" height="450" style="display: none;"></canvas>
            <video id="nativeVideo" controls style="display: none;"></video>
        </div>

        <!-- 控制面板 -->
        <div class="controls" id="controlPanel">
            <div class="control-row">
                <button onclick="togglePlay()" id="playBtn">▶️ 播放</button>
                <button onclick="stopPlay()" id="stopBtn">⏹️ 停止</button>
                <button onclick="toggleMute()" id="muteBtn">🔊 静音</button>
                <button onclick="switchMode()" id="switchBtn">🔄 切换模式</button>
            </div>
        </div>

        <!-- 状态面板 -->
        <div class="status-panel" id="statusPanel" style="display: none;">
            <h3>📊 播放状态</h3>
            <div class="status-item">
                <span>当前模式:</span>
                <span id="currentMode">未选择</span>
            </div>
            <div class="status-item">
                <span>播放状态:</span>
                <span id="playStatus">已停止</span>
            </div>
            <div class="status-item">
                <span>文件信息:</span>
                <span id="fileInfo">未加载</span>
            </div>
            <div class="status-item">
                <span>解码器:</span>
                <span id="decoderInfo">无</span>
            </div>
            <div class="status-item">
                <span>渲染器:</span>
                <span id="rendererInfo">无</span>
            </div>
        </div>

        <!-- 日志面板 -->
        <div class="log-panel" id="logPanel">
            完全修复的播放器启动完成<br>
            等待文件上传...<br>
        </div>
    </div>

    <script type="module">
        // 全局状态
        let currentFile = null;
        let currentMode = 'auto';
        let customPlayer = null;
        let nativeVideo = null;
        let isPlaying = false;
        
        // DOM元素
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const videoDisplay = document.getElementById('videoDisplay');
        const customCanvas = document.getElementById('customCanvas');
        const nativeVideoElement = document.getElementById('nativeVideo');
        const controlPanel = document.getElementById('controlPanel');
        const statusPanel = document.getElementById('statusPanel');
        const logPanel = document.getElementById('logPanel');

        // 日志功能
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#2196F3',
                success: '#4CAF50',
                error: '#f44336',
                warning: '#ff9800'
            };
            
            logPanel.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span><br>`;
            logPanel.scrollTop = logPanel.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // 更新状态显示
        function updateStatus() {
            document.getElementById('currentMode').textContent = currentMode;
            document.getElementById('playStatus').textContent = isPlaying ? '播放中' : '已停止';
            
            if (currentFile) {
                document.getElementById('fileInfo').textContent = 
                    `${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)}MB)`;
            }
        }

        // 设置播放模式
        window.setMode = function(mode) {
            currentMode = mode;
            
            // 更新按钮状态
            document.querySelectorAll('.mode-switch').forEach(btn => btn.classList.remove('active'));
            document.getElementById(mode + 'ModeBtn').classList.add('active');
            
            // 更新描述
            const descriptions = {
                auto: '智能模式：自动选择最佳播放方式',
                custom: '自定义解码：使用WebCodecs/FFmpeg解码器',
                native: '原生播放：使用HTML5 video元素'
            };
            
            document.getElementById('modeDescription').textContent = descriptions[mode];
            log(`切换到${descriptions[mode]}`, 'info');
            updateStatus();
        };

        // 文件上传处理
        uploadZone.addEventListener('click', () => fileInput.click());
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // 文件处理
        async function handleFile(file) {
            log(`文件选择: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`, 'info');
            currentFile = file;
            
            // 显示控制面板和状态面板
            videoDisplay.style.display = 'block';
            controlPanel.style.display = 'block';
            statusPanel.style.display = 'block';
            updateStatus();
            
            // 根据模式加载播放器
            try {
                if (currentMode === 'auto') {
                    await loadWithAutoMode(file);
                } else if (currentMode === 'custom') {
                    await loadWithCustomPlayer(file);
                } else if (currentMode === 'native') {
                    await loadWithNativePlayer(file);
                }
            } catch (error) {
                log(`加载失败: ${error.message}`, 'error');
                
                // 自动回退到原生播放器
                if (currentMode !== 'native') {
                    log('自动回退到原生播放器...', 'warning');
                    setMode('native');
                    await loadWithNativePlayer(file);
                }
            }
        }

        // 智能模式加载
        async function loadWithAutoMode(file) {
            log('智能模式：尝试自定义播放器...', 'info');
            
            try {
                await loadWithCustomPlayer(file);
                log('智能模式：使用自定义播放器', 'success');
            } catch (error) {
                log('智能模式：自定义播放器失败，切换到原生播放器', 'warning');
                await loadWithNativePlayer(file);
            }
        }

        // 自定义播放器加载
        async function loadWithCustomPlayer(file) {
            log('初始化自定义播放器...', 'info');
            
            try {
                // 导入自定义播放器
                const module = await import('./main.js');
                const { WebAVPlayer } = module;
                
                // 隐藏原生视频，显示自定义canvas
                nativeVideoElement.style.display = 'none';
                customCanvas.style.display = 'block';
                
                // 创建播放器实例
                customPlayer = new WebAVPlayer(customCanvas);
                
                // 设置回调
                customPlayer.onMediaReady = () => {
                    log('自定义播放器：媒体准备就绪', 'success');
                    document.getElementById('decoderInfo').textContent = customPlayer.decoder?.constructor?.name || '未知';
                    document.getElementById('rendererInfo').textContent = customPlayer.renderer?.constructor?.name || '未知';
                };
                
                customPlayer.onError = (error) => {
                    log(`自定义播放器错误: ${error}`, 'error');
                    throw new Error(error);
                };
                
                // 初始化并加载文件
                await customPlayer.initialize();
                await customPlayer.loadFile(file);
                
                log('自定义播放器加载成功', 'success');
                
            } catch (error) {
                log(`自定义播放器失败: ${error.message}`, 'error');
                throw error;
            }
        }

        // 原生播放器加载
        async function loadWithNativePlayer(file) {
            log('初始化原生播放器...', 'info');
            
            try {
                // 隐藏自定义canvas，显示原生视频
                customCanvas.style.display = 'none';
                nativeVideoElement.style.display = 'block';
                
                // 创建URL并设置源
                const url = URL.createObjectURL(file);
                nativeVideoElement.src = url;
                nativeVideo = nativeVideoElement;
                
                // 设置事件监听
                nativeVideo.onloadedmetadata = () => {
                    log('原生播放器：元数据加载完成', 'success');
                    document.getElementById('decoderInfo').textContent = '浏览器内置';
                    document.getElementById('rendererInfo').textContent = 'HTML5 Video';
                };
                
                nativeVideo.oncanplay = () => {
                    log('原生播放器：可以开始播放', 'success');
                };
                
                nativeVideo.onerror = (e) => {
                    const error = nativeVideo.error;
                    const errorMessages = {
                        1: '视频下载被中止',
                        2: '网络错误',
                        3: '视频解码失败',
                        4: '不支持的视频格式'
                    };
                    const message = errorMessages[error?.code] || '未知错误';
                    log(`原生播放器错误: ${message}`, 'error');
                    throw new Error(message);
                };
                
                log('原生播放器加载成功', 'success');
                
            } catch (error) {
                log(`原生播放器失败: ${error.message}`, 'error');
                throw error;
            }
        }

        // 播放控制
        window.togglePlay = async function() {
            try {
                if (isPlaying) {
                    // 暂停
                    if (customPlayer) {
                        customPlayer.pause();
                    } else if (nativeVideo) {
                        nativeVideo.pause();
                    }
                    isPlaying = false;
                    document.getElementById('playBtn').textContent = '▶️ 播放';
                    log('播放已暂停', 'info');
                } else {
                    // 播放
                    if (customPlayer) {
                        await customPlayer.play();
                    } else if (nativeVideo) {
                        await nativeVideo.play();
                    }
                    isPlaying = true;
                    document.getElementById('playBtn').textContent = '⏸️ 暂停';
                    log('开始播放', 'success');
                }
                updateStatus();
            } catch (error) {
                log(`播放控制失败: ${error.message}`, 'error');
            }
        };

        window.stopPlay = function() {
            if (customPlayer) {
                customPlayer.pause();
            } else if (nativeVideo) {
                nativeVideo.pause();
                nativeVideo.currentTime = 0;
            }
            isPlaying = false;
            document.getElementById('playBtn').textContent = '▶️ 播放';
            log('播放已停止', 'info');
            updateStatus();
        };

        window.toggleMute = function() {
            let muted = false;
            
            if (customPlayer) {
                // 自定义播放器的静音控制（如果支持）
                if (customPlayer.setVolume) {
                    customPlayer.setVolume(customPlayer.volume > 0 ? 0 : 1);
                    muted = customPlayer.volume === 0;
                }
            } else if (nativeVideo) {
                nativeVideo.muted = !nativeVideo.muted;
                muted = nativeVideo.muted;
            }
            
            document.getElementById('muteBtn').textContent = muted ? '🔇 取消静音' : '🔊 静音';
            log(muted ? '已静音' : '取消静音', 'info');
        };

        window.switchMode = function() {
            const modes = ['auto', 'custom', 'native'];
            const currentIndex = modes.indexOf(currentMode);
            const nextMode = modes[(currentIndex + 1) % modes.length];
            
            setMode(nextMode);
            
            // 如果有文件加载，重新加载
            if (currentFile) {
                log('模式切换，重新加载文件...', 'info');
                handleFile(currentFile);
            }
        };

        // 初始化
        setMode('auto');
        log('完全修复的播放器启动完成', 'success');
        log('支持智能模式、自定义解码和原生播放', 'info');
    </script>
</body>
</html>