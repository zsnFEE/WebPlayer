<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ å®Œå…¨ä¿®å¤çš„æ’­æ”¾å™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .player-container {
            background: rgba(0,0,0,0.7);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .upload-zone {
            border: 2px dashed #4CAF50;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: rgba(76, 175, 80, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }
        .upload-zone:hover {
            background: rgba(76, 175, 80, 0.2);
            transform: translateY(-2px);
        }
        .upload-zone.dragover {
            background: rgba(76, 175, 80, 0.3);
            border-color: #81C784;
        }
        input[type="file"] {
            display: none;
        }
        .video-display {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        canvas, video {
            width: 100%;
            max-width: 800px;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        .controls {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        .control-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }
        button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .mode-switch {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196F3;
            color: #81C784;
        }
        .mode-switch.active {
            background: #2196F3;
            color: white;
        }
        .status-panel {
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .log-panel {
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ å®Œå…¨ä¿®å¤çš„æ’­æ”¾å™¨</h1>
        <p>æ™ºèƒ½æ’­æ”¾å™¨ - è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ’­æ”¾æ–¹å¼</p>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-zone" id="uploadZone">
            <h3>ğŸ“ ä¸Šä¼ è§†é¢‘æ–‡ä»¶</h3>
            <p>æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
            <input type="file" id="fileInput" accept="video/*">
        </div>

        <!-- æ’­æ”¾æ¨¡å¼é€‰æ‹© -->
        <div class="player-container">
            <h3>ğŸ¯ æ’­æ”¾æ¨¡å¼</h3>
            <div class="control-row">
                <button class="mode-switch" id="autoModeBtn" onclick="setMode('auto')">ğŸ¤– æ™ºèƒ½æ¨¡å¼</button>
                <button class="mode-switch" id="customModeBtn" onclick="setMode('custom')">âš™ï¸ è‡ªå®šä¹‰è§£ç </button>
                <button class="mode-switch" id="nativeModeBtn" onclick="setMode('native')">ğŸ  åŸç”Ÿæ’­æ”¾</button>
            </div>
            <p id="modeDescription">æ™ºèƒ½æ¨¡å¼ï¼šè‡ªåŠ¨é€‰æ‹©æœ€ä½³æ’­æ”¾æ–¹å¼</p>
        </div>

        <!-- è§†é¢‘æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="video-display" id="videoDisplay">
            <canvas id="customCanvas" width="800" height="450" style="display: none;"></canvas>
            <video id="nativeVideo" controls style="display: none;"></video>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls" id="controlPanel">
            <div class="control-row">
                <button onclick="togglePlay()" id="playBtn">â–¶ï¸ æ’­æ”¾</button>
                <button onclick="stopPlay()" id="stopBtn">â¹ï¸ åœæ­¢</button>
                <button onclick="toggleMute()" id="muteBtn">ğŸ”Š é™éŸ³</button>
                <button onclick="switchMode()" id="switchBtn">ğŸ”„ åˆ‡æ¢æ¨¡å¼</button>
            </div>
        </div>

        <!-- çŠ¶æ€é¢æ¿ -->
        <div class="status-panel" id="statusPanel" style="display: none;">
            <h3>ğŸ“Š æ’­æ”¾çŠ¶æ€</h3>
            <div class="status-item">
                <span>å½“å‰æ¨¡å¼:</span>
                <span id="currentMode">æœªé€‰æ‹©</span>
            </div>
            <div class="status-item">
                <span>æ’­æ”¾çŠ¶æ€:</span>
                <span id="playStatus">å·²åœæ­¢</span>
            </div>
            <div class="status-item">
                <span>æ–‡ä»¶ä¿¡æ¯:</span>
                <span id="fileInfo">æœªåŠ è½½</span>
            </div>
            <div class="status-item">
                <span>è§£ç å™¨:</span>
                <span id="decoderInfo">æ— </span>
            </div>
            <div class="status-item">
                <span>æ¸²æŸ“å™¨:</span>
                <span id="rendererInfo">æ— </span>
            </div>
        </div>

        <!-- æ—¥å¿—é¢æ¿ -->
        <div class="log-panel" id="logPanel">
            å®Œå…¨ä¿®å¤çš„æ’­æ”¾å™¨å¯åŠ¨å®Œæˆ<br>
            ç­‰å¾…æ–‡ä»¶ä¸Šä¼ ...<br>
        </div>
    </div>

    <script type="module">
        // å…¨å±€çŠ¶æ€
        let currentFile = null;
        let currentMode = 'auto';
        let customPlayer = null;
        let nativeVideo = null;
        let isPlaying = false;
        
        // DOMå…ƒç´ 
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const videoDisplay = document.getElementById('videoDisplay');
        const customCanvas = document.getElementById('customCanvas');
        const nativeVideoElement = document.getElementById('nativeVideo');
        const controlPanel = document.getElementById('controlPanel');
        const statusPanel = document.getElementById('statusPanel');
        const logPanel = document.getElementById('logPanel');

        // æ—¥å¿—åŠŸèƒ½
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#2196F3',
                success: '#4CAF50',
                error: '#f44336',
                warning: '#ff9800'
            };
            
            logPanel.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span><br>`;
            logPanel.scrollTop = logPanel.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            document.getElementById('currentMode').textContent = currentMode;
            document.getElementById('playStatus').textContent = isPlaying ? 'æ’­æ”¾ä¸­' : 'å·²åœæ­¢';
            
            if (currentFile) {
                document.getElementById('fileInfo').textContent = 
                    `${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)}MB)`;
            }
        }

        // è®¾ç½®æ’­æ”¾æ¨¡å¼
        window.setMode = function(mode) {
            currentMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mode-switch').forEach(btn => btn.classList.remove('active'));
            document.getElementById(mode + 'ModeBtn').classList.add('active');
            
            // æ›´æ–°æè¿°
            const descriptions = {
                auto: 'æ™ºèƒ½æ¨¡å¼ï¼šè‡ªåŠ¨é€‰æ‹©æœ€ä½³æ’­æ”¾æ–¹å¼',
                custom: 'è‡ªå®šä¹‰è§£ç ï¼šä½¿ç”¨WebCodecs/FFmpegè§£ç å™¨',
                native: 'åŸç”Ÿæ’­æ”¾ï¼šä½¿ç”¨HTML5 videoå…ƒç´ '
            };
            
            document.getElementById('modeDescription').textContent = descriptions[mode];
            log(`åˆ‡æ¢åˆ°${descriptions[mode]}`, 'info');
            updateStatus();
        };

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        uploadZone.addEventListener('click', () => fileInput.click());
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // æ–‡ä»¶å¤„ç†
        async function handleFile(file) {
            log(`æ–‡ä»¶é€‰æ‹©: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`, 'info');
            currentFile = file;
            
            // æ˜¾ç¤ºæ§åˆ¶é¢æ¿å’ŒçŠ¶æ€é¢æ¿
            videoDisplay.style.display = 'block';
            controlPanel.style.display = 'block';
            statusPanel.style.display = 'block';
            updateStatus();
            
            // æ ¹æ®æ¨¡å¼åŠ è½½æ’­æ”¾å™¨
            try {
                if (currentMode === 'auto') {
                    await loadWithAutoMode(file);
                } else if (currentMode === 'custom') {
                    await loadWithCustomPlayer(file);
                } else if (currentMode === 'native') {
                    await loadWithNativePlayer(file);
                }
            } catch (error) {
                log(`åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                
                // è‡ªåŠ¨å›é€€åˆ°åŸç”Ÿæ’­æ”¾å™¨
                if (currentMode !== 'native') {
                    log('è‡ªåŠ¨å›é€€åˆ°åŸç”Ÿæ’­æ”¾å™¨...', 'warning');
                    setMode('native');
                    await loadWithNativePlayer(file);
                }
            }
        }

        // æ™ºèƒ½æ¨¡å¼åŠ è½½
        async function loadWithAutoMode(file) {
            log('æ™ºèƒ½æ¨¡å¼ï¼šå°è¯•è‡ªå®šä¹‰æ’­æ”¾å™¨...', 'info');
            
            try {
                await loadWithCustomPlayer(file);
                log('æ™ºèƒ½æ¨¡å¼ï¼šä½¿ç”¨è‡ªå®šä¹‰æ’­æ”¾å™¨', 'success');
            } catch (error) {
                log('æ™ºèƒ½æ¨¡å¼ï¼šè‡ªå®šä¹‰æ’­æ”¾å™¨å¤±è´¥ï¼Œåˆ‡æ¢åˆ°åŸç”Ÿæ’­æ”¾å™¨', 'warning');
                await loadWithNativePlayer(file);
            }
        }

        // è‡ªå®šä¹‰æ’­æ”¾å™¨åŠ è½½
        async function loadWithCustomPlayer(file) {
            log('åˆå§‹åŒ–è‡ªå®šä¹‰æ’­æ”¾å™¨...', 'info');
            
            try {
                // å¯¼å…¥è‡ªå®šä¹‰æ’­æ”¾å™¨
                const module = await import('./main.js');
                const { WebAVPlayer } = module;
                
                // éšè—åŸç”Ÿè§†é¢‘ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰canvas
                nativeVideoElement.style.display = 'none';
                customCanvas.style.display = 'block';
                
                // åˆ›å»ºæ’­æ”¾å™¨å®ä¾‹
                customPlayer = new WebAVPlayer(customCanvas);
                
                // è®¾ç½®å›è°ƒ
                customPlayer.onMediaReady = () => {
                    log('è‡ªå®šä¹‰æ’­æ”¾å™¨ï¼šåª’ä½“å‡†å¤‡å°±ç»ª', 'success');
                    document.getElementById('decoderInfo').textContent = customPlayer.decoder?.constructor?.name || 'æœªçŸ¥';
                    document.getElementById('rendererInfo').textContent = customPlayer.renderer?.constructor?.name || 'æœªçŸ¥';
                };
                
                customPlayer.onError = (error) => {
                    log(`è‡ªå®šä¹‰æ’­æ”¾å™¨é”™è¯¯: ${error}`, 'error');
                    throw new Error(error);
                };
                
                // åˆå§‹åŒ–å¹¶åŠ è½½æ–‡ä»¶
                await customPlayer.initialize();
                await customPlayer.loadFile(file);
                
                log('è‡ªå®šä¹‰æ’­æ”¾å™¨åŠ è½½æˆåŠŸ', 'success');
                
            } catch (error) {
                log(`è‡ªå®šä¹‰æ’­æ”¾å™¨å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        // åŸç”Ÿæ’­æ”¾å™¨åŠ è½½
        async function loadWithNativePlayer(file) {
            log('åˆå§‹åŒ–åŸç”Ÿæ’­æ”¾å™¨...', 'info');
            
            try {
                // éšè—è‡ªå®šä¹‰canvasï¼Œæ˜¾ç¤ºåŸç”Ÿè§†é¢‘
                customCanvas.style.display = 'none';
                nativeVideoElement.style.display = 'block';
                
                // åˆ›å»ºURLå¹¶è®¾ç½®æº
                const url = URL.createObjectURL(file);
                nativeVideoElement.src = url;
                nativeVideo = nativeVideoElement;
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬
                nativeVideo.onloadedmetadata = () => {
                    log('åŸç”Ÿæ’­æ”¾å™¨ï¼šå…ƒæ•°æ®åŠ è½½å®Œæˆ', 'success');
                    document.getElementById('decoderInfo').textContent = 'æµè§ˆå™¨å†…ç½®';
                    document.getElementById('rendererInfo').textContent = 'HTML5 Video';
                };
                
                nativeVideo.oncanplay = () => {
                    log('åŸç”Ÿæ’­æ”¾å™¨ï¼šå¯ä»¥å¼€å§‹æ’­æ”¾', 'success');
                };
                
                nativeVideo.onerror = (e) => {
                    const error = nativeVideo.error;
                    const errorMessages = {
                        1: 'è§†é¢‘ä¸‹è½½è¢«ä¸­æ­¢',
                        2: 'ç½‘ç»œé”™è¯¯',
                        3: 'è§†é¢‘è§£ç å¤±è´¥',
                        4: 'ä¸æ”¯æŒçš„è§†é¢‘æ ¼å¼'
                    };
                    const message = errorMessages[error?.code] || 'æœªçŸ¥é”™è¯¯';
                    log(`åŸç”Ÿæ’­æ”¾å™¨é”™è¯¯: ${message}`, 'error');
                    throw new Error(message);
                };
                
                log('åŸç”Ÿæ’­æ”¾å™¨åŠ è½½æˆåŠŸ', 'success');
                
            } catch (error) {
                log(`åŸç”Ÿæ’­æ”¾å™¨å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        // æ’­æ”¾æ§åˆ¶
        window.togglePlay = async function() {
            try {
                if (isPlaying) {
                    // æš‚åœ
                    if (customPlayer) {
                        customPlayer.pause();
                    } else if (nativeVideo) {
                        nativeVideo.pause();
                    }
                    isPlaying = false;
                    document.getElementById('playBtn').textContent = 'â–¶ï¸ æ’­æ”¾';
                    log('æ’­æ”¾å·²æš‚åœ', 'info');
                } else {
                    // æ’­æ”¾
                    if (customPlayer) {
                        await customPlayer.play();
                    } else if (nativeVideo) {
                        await nativeVideo.play();
                    }
                    isPlaying = true;
                    document.getElementById('playBtn').textContent = 'â¸ï¸ æš‚åœ';
                    log('å¼€å§‹æ’­æ”¾', 'success');
                }
                updateStatus();
            } catch (error) {
                log(`æ’­æ”¾æ§åˆ¶å¤±è´¥: ${error.message}`, 'error');
            }
        };

        window.stopPlay = function() {
            if (customPlayer) {
                customPlayer.pause();
            } else if (nativeVideo) {
                nativeVideo.pause();
                nativeVideo.currentTime = 0;
            }
            isPlaying = false;
            document.getElementById('playBtn').textContent = 'â–¶ï¸ æ’­æ”¾';
            log('æ’­æ”¾å·²åœæ­¢', 'info');
            updateStatus();
        };

        window.toggleMute = function() {
            let muted = false;
            
            if (customPlayer) {
                // è‡ªå®šä¹‰æ’­æ”¾å™¨çš„é™éŸ³æ§åˆ¶ï¼ˆå¦‚æœæ”¯æŒï¼‰
                if (customPlayer.setVolume) {
                    customPlayer.setVolume(customPlayer.volume > 0 ? 0 : 1);
                    muted = customPlayer.volume === 0;
                }
            } else if (nativeVideo) {
                nativeVideo.muted = !nativeVideo.muted;
                muted = nativeVideo.muted;
            }
            
            document.getElementById('muteBtn').textContent = muted ? 'ğŸ”‡ å–æ¶ˆé™éŸ³' : 'ğŸ”Š é™éŸ³';
            log(muted ? 'å·²é™éŸ³' : 'å–æ¶ˆé™éŸ³', 'info');
        };

        window.switchMode = function() {
            const modes = ['auto', 'custom', 'native'];
            const currentIndex = modes.indexOf(currentMode);
            const nextMode = modes[(currentIndex + 1) % modes.length];
            
            setMode(nextMode);
            
            // å¦‚æœæœ‰æ–‡ä»¶åŠ è½½ï¼Œé‡æ–°åŠ è½½
            if (currentFile) {
                log('æ¨¡å¼åˆ‡æ¢ï¼Œé‡æ–°åŠ è½½æ–‡ä»¶...', 'info');
                handleFile(currentFile);
            }
        };

        // åˆå§‹åŒ–
        setMode('auto');
        log('å®Œå…¨ä¿®å¤çš„æ’­æ”¾å™¨å¯åŠ¨å®Œæˆ', 'success');
        log('æ”¯æŒæ™ºèƒ½æ¨¡å¼ã€è‡ªå®šä¹‰è§£ç å’ŒåŸç”Ÿæ’­æ”¾', 'info');
    </script>
</body>
</html>